<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doro AI Poster Pro - 专业海报工坊</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0f172a; 
            color: #e2e8f0;
            overflow: hidden; /* 全局禁止滚动，由内部容器接管 */
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .resize-handle {
            width: 16px; height: 16px;
            background: #38bdf8;
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            bottom: -8px; right: -8px;
            cursor: se-resize;
            z-index: 50;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 16px; width: 16px; 
            border-radius: 50%; background: #38bdf8; 
            margin-top: -6px; cursor: pointer; border: 2px solid #0f172a;
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #334155; border-radius: 2px; }

        .font-poster { font-family: 'Impact', 'Arial Black', sans-serif; letter-spacing: 0.02em; }
        
        .bg-grid-pattern {
            background-image: 
                linear-gradient(to right, rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 24px 24px;
        }
        
        .input-dark {
            background-color: #1e293b; border: 1px solid #334155; color: white; transition: all 0.2s;
        }
        .input-dark:focus { border-color: #38bdf8; outline: none; }
    </style>
</head>
<body class="h-screen flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Image, Settings, Sparkles, Download, AlertCircle, Loader2, Key, Palette, Trash2, LayoutTemplate, Camera, ChevronLeft, Type, AlignCenter, AlignLeft, AlignRight, Pipette, Maximize, Smartphone, Monitor, Square, Ratio, MoveDiagonal, Layers, Plus, Box, Upload, ArrowRight, HelpCircle, CheckCircle2, X, MousePointer2, Sliders, Lightbulb, GraduationCap, Grip, RefreshCcw } from 'lucide-react';

        const App = () => {
            // --- 状态管理 ---
            const [apiKey, setApiKey] = useState('');
            const [baseUrl, setBaseUrl] = useState('https://api.bltcy.ai/v1');
            const [showSettings, setShowSettings] = useState(false);
            const [showTutorial, setShowTutorial] = useState(false);
            const [tutorialTab, setTutorialTab] = useState('fusion'); 
            
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [resultImage, setResultImage] = useState(null);

            // 模式与尺寸
            const [mode, setMode] = useState('text2img'); 
            const [sizeMode, setSizeMode] = useState('preset');
            const [presetSize, setPresetSize] = useState('576x1024');
            const [customW, setCustomW] = useState('576');
            const [customH, setCustomH] = useState('1024');

            // Text2Img
            const [prompt, setPrompt] = useState('');

            // Fusion
            const [fusionBg, setFusionBg] = useState(null);
            const [fusionItems, setFusionItems] = useState([]);
            const [selectedItemId, setSelectedItemId] = useState(null);
            const [fusionPrompt, setFusionPrompt] = useState('cinematic lighting, realistic shadows, perfect blending, 8k resolution');
            const [fusionStrength, setFusionStrength] = useState(0.55);
            
            // 拖拽逻辑
            const [isDragging, setIsDragging] = useState(false);
            const [dragType, setDragType] = useState(null);
            const dragStartPos = useRef({ x: 0, y: 0 });
            const initialItemState = useRef(null);

            const fileInputBgRef = useRef(null);
            const fileInputItemRef = useRef(null);
            const compositionRef = useRef(null); 
            const posterRef = useRef(null); 

            // 海报文字
            const [posterTitle, setPosterTitle] = useState('FUSION ART');
            const [posterSubtitle, setPosterSubtitle] = useState('AI GENERATED DESIGN');
            const [textColor, setTextColor] = useState('#ffffff');
            const [textAlign, setTextAlign] = useState('center');

            // 初始化
            useEffect(() => {
                const storedKey = localStorage.getItem('plato_api_key');
                const storedBaseUrl = localStorage.getItem('plato_base_url');
                if (storedKey) setApiKey(storedKey);
                if (storedBaseUrl) setBaseUrl(storedBaseUrl);

                const hasSeenTutorial = localStorage.getItem('doro_poster_tutorial_seen_v6'); 
                if (!hasSeenTutorial) setShowTutorial(true);
            }, []);

            // --- 交互逻辑 (拖拽/缩放) ---
            const handleMouseDown = (e, itemId, type) => {
                e.stopPropagation(); e.preventDefault();
                setSelectedItemId(itemId); setIsDragging(true); setDragType(type);
                const item = fusionItems.find(i => i.id === itemId);
                initialItemState.current = { ...item };
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                dragStartPos.current = { x: clientX, y: clientY };
            };

            const handleMouseMove = (e) => {
                if (!isDragging || !selectedItemId || !compositionRef.current) return;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const deltaX = clientX - dragStartPos.current.x;
                const deltaY = clientY - dragStartPos.current.y;
                const containerRect = compositionRef.current.getBoundingClientRect();
                const deltaXPercent = (deltaX / containerRect.width) * 100;
                const deltaYPercent = (deltaY / containerRect.height) * 100;

                if (dragType === 'move') {
                    updateItem(selectedItemId, { x: initialItemState.current.x + deltaXPercent, y: initialItemState.current.y + deltaYPercent });
                } else if (dragType === 'resize') {
                    const newScale = Math.max(5, Math.min(100, initialItemState.current.scale + deltaXPercent));
                    updateItem(selectedItemId, { scale: newScale });
                }
            };

            const handleMouseUp = () => { setIsDragging(false); setDragType(null); };

            useEffect(() => {
                if (isDragging) {
                    window.addEventListener('mousemove', handleMouseMove); window.addEventListener('mouseup', handleMouseUp);
                    window.addEventListener('touchmove', handleMouseMove, { passive: false }); window.addEventListener('touchend', handleMouseUp);
                }
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove); window.removeEventListener('mouseup', handleMouseUp);
                    window.removeEventListener('touchmove', handleMouseMove); window.removeEventListener('touchend', handleMouseUp);
                };
            }, [isDragging, selectedItemId]);

            // --- 数据处理 ---
            const handleBgUpload = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader(); reader.onloadend = () => setFusionBg(reader.result); reader.readAsDataURL(file);
            };

            const handleItemUpload = (e) => {
                const file = e.target.files[0]; if (!file) return;
                if (fusionItems.length >= 5) return setError('最多支持5个物品');
                const reader = new FileReader();
                reader.onloadend = () => {
                    const newItem = { id: Date.now(), src: reader.result, x: 50, y: 50, scale: 30 };
                    setFusionItems([...fusionItems, newItem]); setSelectedItemId(newItem.id);
                };
                reader.readAsDataURL(file);
            };

            const updateItem = (id, changes) => setFusionItems(items => items.map(i => i.id === id ? { ...i, ...changes } : i));
            const deleteItem = (id) => { setFusionItems(items => items.filter(i => i.id !== id)); if (selectedItemId === id) setSelectedItemId(null); };

            // --- 生成核心 ---
            const generateImage = async () => {
                if (!apiKey) { setShowSettings(true); return setError('请先配置 API Key'); }
                setLoading(true); setError(''); setResultImage(null);

                try {
                    const cleanBaseUrl = baseUrl.replace(/\/$/, '');
                    const endpoint = cleanBaseUrl.endsWith('/v1') ? `${cleanBaseUrl}/images/generations` : `${cleanBaseUrl}/v1/images/generations`;
                    
                    // 尺寸解析
                    const width = sizeMode === 'custom' ? parseInt(customW) : parseInt(presetSize.split('x')[0]);
                    const height = sizeMode === 'custom' ? parseInt(customH) : parseInt(presetSize.split('x')[1]);
                    
                    let payload = { model: 'nano-banana', n: 1, size: `${width}x${height}` };

                    if (mode === 'fusion') {
                        if (!fusionBg) throw new Error("请先上传环境背景图");
                        
                        const tempSelected = selectedItemId; setSelectedItemId(null);
                        await new Promise(r => setTimeout(r, 100)); 

                        if (!compositionRef.current) throw new Error("拼贴区域未加载");
                        
                        // 核心修复：设置 html2canvas 的宽高，使其强制匹配目标比例
                        const canvas = await html2canvas(compositionRef.current, { 
                            useCORS: true, 
                            backgroundColor: null, 
                            scale: 2,
                            width: compositionRef.current.offsetWidth,
                            height: compositionRef.current.offsetHeight
                        });
                        
                        setSelectedItemId(tempSelected);
                        
                        payload.prompt = fusionPrompt;
                        payload.image = canvas.toDataURL('image/png').split(',')[1];
                        payload.strength = parseFloat(fusionStrength);
                    } else {
                        if (!prompt) throw new Error("请输入提示词");
                        payload.prompt = prompt;
                    }

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error?.message || '生成失败');
                    if (data.data?.[0]?.url) setResultImage(data.data[0].url); else throw new Error('API 返回数据为空');

                } catch (err) { setError(err.message); } finally { setLoading(false); }
            };

            const downloadPoster = async () => {
                if (!posterRef.current) return;
                try {
                    const canvas = await html2canvas(posterRef.current, { useCORS: true, scale: 3, backgroundColor: '#000' });
                    const link = document.createElement('a'); link.download = `doro-poster-${Date.now()}.png`; link.href = canvas.toDataURL('image/png'); link.click();
                } catch (e) { setError("保存失败"); }
            };

            const closeTutorial = (dontShow) => {
                setShowTutorial(false); if (dontShow) localStorage.setItem('doro_poster_tutorial_seen_v6', 'true');
            };

            // --- 计算当前比例 ---
            const getAspectRatioStyle = () => {
                let w, h;
                if (sizeMode === 'custom') {
                    w = parseFloat(customW); h = parseFloat(customH);
                } else {
                    [w, h] = presetSize.split('x').map(Number);
                }
                return { aspectRatio: `${w} / ${h}` };
            };

            // --- 组件: 尺寸选择器 ---
            const SizeSelector = () => (
                <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                    <div className="flex justify-between items-center mb-3">
                        <label className="text-xs text-slate-400 uppercase tracking-wider font-bold flex items-center gap-2"><Maximize size={14} className="text-sky-400"/> 画布尺寸</label>
                        <div className="flex bg-slate-900 rounded-lg p-0.5 border border-slate-700">
                            <button onClick={() => setSizeMode('preset')} className={`px-3 py-1 text-[10px] rounded-md transition-all font-medium ${sizeMode === 'preset' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-500 hover:text-slate-300'}`}>预设</button>
                            <button onClick={() => setSizeMode('custom')} className={`px-3 py-1 text-[10px] rounded-md transition-all font-medium ${sizeMode === 'custom' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-500 hover:text-slate-300'}`}>自定义</button>
                        </div>
                    </div>
                    {sizeMode === 'preset' ? (
                        <div className="relative">
                            <select value={presetSize} onChange={e => setPresetSize(e.target.value)} className="input-dark w-full rounded-lg px-3 py-2.5 text-sm outline-none appearance-none font-medium cursor-pointer">
                                <option value="576x1024">手机 9:16 (576x1024)</option>
                                <option value="768x1024">标准 3:4 (768x1024)</option>
                                <option value="768x1152">海报 2:3 (768x1152)</option>
                                <option value="1024x1024">方形 1:1 (1024x1024)</option>
                                <option value="1024x768">横版 4:3 (1024x768)</option>
                                <option value="1024x576">宽屏 16:9 (1024x576)</option>
                            </select>
                            <div className="absolute right-3 top-3 text-slate-500 pointer-events-none"><ArrowRight size={14} className="rotate-90"/></div>
                        </div>
                    ) : (
                        <div className="flex gap-2 items-center">
                            <input type="number" value={customW} onChange={e => setCustomW(e.target.value)} className="input-dark w-full rounded-lg p-2.5 text-sm text-center font-mono" placeholder="W"/>
                            <span className="text-slate-500 text-xs font-bold">×</span>
                            <input type="number" value={customH} onChange={e => setCustomH(e.target.value)} className="input-dark w-full rounded-lg p-2.5 text-sm text-center font-mono" placeholder="H"/>
                        </div>
                    )}
                </div>
            );

            return (
                <div className="h-full flex flex-col">
                    {/* Header */}
                    <nav className="border-b border-slate-800 bg-slate-900/90 backdrop-blur-md h-16 flex-none z-20">
                        <div className="w-full h-full px-4 flex items-center justify-between">
                            <div className="flex items-center gap-3 lg:gap-6">
                                <a href="index.html" className="p-2 hover:bg-slate-800 rounded-full transition-colors text-slate-400 hover:text-white" title="返回主页"><ChevronLeft size={20} /></a>
                                <div className="flex items-center gap-2">
                                    <div className="bg-gradient-to-br from-sky-500 to-blue-600 p-1.5 rounded-lg shadow-lg shadow-sky-500/20 hidden sm:block">
                                        <LayoutTemplate size={18} className="text-white" />
                                    </div>
                                    <span className="font-bold text-lg tracking-tight text-white">Poster <span className="text-sky-400 font-normal text-xs bg-sky-900/30 px-1.5 py-0.5 rounded border border-sky-500/20 ml-1">PRO</span></span>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setShowTutorial(true)} className="text-xs font-medium text-slate-300 hover:text-white flex items-center gap-1.5 bg-slate-800 hover:bg-slate-700 border border-slate-700 px-3 py-1.5 rounded-full transition-all">
                                    <GraduationCap size={14} className="text-purple-400"/> <span className="hidden sm:inline">教程</span>
                                </button>
                                <button onClick={() => setShowSettings(!showSettings)} className="p-2 hover:bg-slate-800 rounded-full transition-colors text-slate-400 hover:text-white">
                                    <Settings size={20} />
                                </button>
                            </div>
                        </div>
                    </nav>

                    {/* Tutorial & Settings (Code omitted for brevity, logic identical to previous) */}
                    {/* Tutorial Modal (Same as before) */}
                    {showTutorial && (
                        <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-4xl h-full max-h-[85vh] flex flex-col shadow-2xl overflow-hidden relative">
                                <button onClick={() => closeTutorial(false)} className="absolute top-4 right-4 text-slate-400 hover:text-white z-20 bg-slate-900/50 rounded-full p-1"><X size={20}/></button>
                                <div className="flex flex-col md:flex-row h-full overflow-hidden">
                                    <div className="w-full md:w-56 bg-slate-950 border-b md:border-b-0 md:border-r border-slate-800 p-4 flex flex-row md:flex-col gap-2 shrink-0 overflow-x-auto">
                                        <button onClick={() => setTutorialTab('fusion')} className={`flex-1 md:flex-none flex items-center justify-center md:justify-start gap-2 px-4 py-3 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${tutorialTab === 'fusion' ? 'bg-purple-600 text-white shadow-lg shadow-purple-900/20' : 'text-slate-400 hover:bg-slate-900 hover:text-white'}`}>
                                            <Layers size={16}/> 物品融合
                                        </button>
                                        <button onClick={() => setTutorialTab('text2img')} className={`flex-1 md:flex-none flex items-center justify-center md:justify-start gap-2 px-4 py-3 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${tutorialTab === 'text2img' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' : 'text-slate-400 hover:bg-slate-900 hover:text-white'}`}>
                                            <Sparkles size={16}/> 文生海报
                                        </button>
                                    </div>
                                    <div className="flex-1 p-6 md:p-8 overflow-y-auto bg-slate-900">
                                        {tutorialTab === 'fusion' ? (
                                            <div className="space-y-6 animate-fade-in max-w-2xl mx-auto">
                                                <h2 className="text-xl font-bold text-white mb-2 flex items-center gap-2"><Layers className="text-purple-400"/> 物品融合模式</h2>
                                                <p className="text-slate-400 text-sm">通过“拼贴 + AI重绘”，将产品完美融入任何背景。</p>
                                                <div className="space-y-4">
                                                    <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50"><h4 className="text-white font-bold text-sm mb-1">1. 上传素材</h4><p className="text-xs text-slate-400">上传背景图 + 产品图（推荐透明底PNG）。</p></div>
                                                    <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50"><h4 className="text-white font-bold text-sm mb-1">2. 调节融合度</h4><p className="text-xs text-slate-400">数值推荐 0.5-0.6。</p></div>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="space-y-6 animate-fade-in max-w-2xl mx-auto">
                                                <h2 className="text-xl font-bold text-white mb-2 flex items-center gap-2"><Sparkles className="text-blue-400"/> 文生海报模式</h2>
                                                <p className="text-slate-400 text-sm">输入文字提示，AI 自动生成创意海报背景。</p>
                                                <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50"><h4 className="text-white font-bold text-sm mb-1">提示词技巧</h4><p className="text-xs text-slate-400">主体 + 环境 + 光照 + 风格。</p></div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div className="p-4 bg-slate-950 border-t border-slate-800 flex justify-between items-center shrink-0">
                                    <button onClick={() => closeTutorial(true)} className="text-xs text-slate-500 hover:text-slate-300 flex items-center gap-2"><div className="w-4 h-4 border border-slate-600 rounded"></div> 不再显示</button>
                                    <button onClick={() => closeTutorial(false)} className="px-6 py-2 bg-white text-slate-900 font-bold text-xs rounded-lg hover:bg-slate-200">开始</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settings Modal (Same as before) */}
                    {showSettings && (
                        <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-slate-900 border border-slate-700 rounded-xl p-6 w-full max-w-md shadow-2xl">
                                <h3 className="font-bold mb-4 text-white">API 设置</h3>
                                <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="API Key" className="input-dark w-full rounded-lg p-3 text-sm mb-3" />
                                <input type="text" value={baseUrl} onChange={e => setBaseUrl(e.target.value)} placeholder="Base URL" className="input-dark w-full rounded-lg p-3 text-sm mb-4" />
                                <button onClick={() => { localStorage.setItem('plato_api_key', apiKey); localStorage.setItem('plato_base_url', baseUrl); setShowSettings(false); }} className="w-full bg-sky-600 hover:bg-sky-500 text-white py-3 rounded-lg font-bold transition-colors">保存</button>
                            </div>
                        </div>
                    )}

                    <main className="flex-1 flex flex-col lg:flex-row overflow-hidden relative">
                        
                        {/* Left Sidebar: Controls */}
                        <div className="w-full lg:w-[420px] xl:w-[460px] bg-[#0f172a] border-b lg:border-b-0 lg:border-r border-slate-800 flex flex-col z-10 shrink-0 h-[40vh] lg:h-full shadow-2xl">
                            <div className="flex-1 overflow-y-auto p-5 space-y-6 no-scrollbar">
                                {/* Mode Tabs */}
                                <div className="bg-slate-800 p-1 rounded-xl flex shadow-inner">
                                    <button onClick={() => setMode('text2img')} className={`flex-1 py-2.5 text-xs font-bold rounded-lg flex items-center justify-center gap-2 transition-all ${mode === 'text2img' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`}><Sparkles size={14}/> 文生海报</button>
                                    <button onClick={() => setMode('fusion')} className={`flex-1 py-2.5 text-xs font-bold rounded-lg flex items-center justify-center gap-2 transition-all ${mode === 'fusion' ? 'bg-purple-600 text-white shadow-md' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`}><Layers size={14}/> 物品融合</button>
                                </div>

                                {/* Size Selector */}
                                <SizeSelector />

                                {/* Fusion Controls */}
                                {mode === 'fusion' && (
                                    <div className="space-y-5 animate-fade-in">
                                        <div className="grid grid-cols-2 gap-3">
                                            <div onClick={() => fileInputBgRef.current?.click()} className={`border-2 border-dashed rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer h-24 transition-all group relative overflow-hidden ${fusionBg ? 'border-green-500/50 bg-green-500/5' : 'border-slate-700 hover:border-slate-500 hover:bg-slate-800'}`}>
                                                {fusionBg ? (
                                                    <>
                                                        <img src={fusionBg} className="w-full h-full object-cover rounded opacity-60" />
                                                        <button onClick={(e) => { e.stopPropagation(); setFusionBg(null); }} className="absolute top-1 right-1 bg-red-500/80 hover:bg-red-600 text-white rounded-full p-1 z-10"><X size={12} /></button>
                                                    </>
                                                ) : (
                                                    <div className="text-slate-500 group-hover:text-slate-300 flex flex-col items-center transition-colors"><Image size={20} className="mb-1"/><span className="text-xs font-bold">背景图</span></div>
                                                )}
                                                <input type="file" ref={fileInputBgRef} className="hidden" accept="image/*" onChange={handleBgUpload}/>
                                            </div>
                                            <div onClick={() => fileInputItemRef.current?.click()} className={`border-2 border-dashed rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer h-24 transition-all group ${fusionItems.length >= 5 ? 'opacity-50 cursor-not-allowed' : 'border-slate-700 hover:border-slate-500 hover:bg-slate-800'}`}>
                                                <Plus size={20} className="text-slate-500 group-hover:text-purple-400 mb-1"/>
                                                <span className="text-xs text-slate-500 group-hover:text-slate-300 font-bold">加物品 ({fusionItems.length}/5)</span>
                                                <input type="file" ref={fileInputItemRef} className="hidden" accept="image/*" onChange={handleItemUpload} disabled={fusionItems.length >= 5}/>
                                            </div>
                                        </div>

                                        {/* Items List */}
                                        {fusionItems.length > 0 && (
                                            <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                                {fusionItems.map((item, idx) => (
                                                    <div key={item.id} onClick={() => setSelectedItemId(item.id)} className={`w-16 h-16 flex-shrink-0 rounded-lg border relative overflow-visible cursor-pointer transition-all group ${selectedItemId === item.id ? 'border-purple-500 ring-2 ring-purple-500/30' : 'border-slate-700'}`}>
                                                        <div className="w-full h-full overflow-hidden rounded-lg"><img src={item.src} className="w-full h-full object-cover"/></div>
                                                        <div className="absolute top-0 left-0 bg-black/60 text-[8px] px-1 rounded-br text-white">{idx + 1}</div>
                                                        <button onClick={(e) => { e.stopPropagation(); deleteItem(item.id); }} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5 shadow-md hover:bg-red-600 transition-colors z-20"><X size={12} /></button>
                                                    </div>
                                                ))}
                                            </div>
                                        )}

                                        <div className="bg-slate-800/30 p-4 rounded-xl border border-slate-700/50">
                                            <div className="flex justify-between mb-2"><label className="text-xs text-slate-400 font-bold flex items-center gap-1.5"><Sliders size={12}/> AI 融合程度</label><span className="text-xs text-purple-400 font-mono">{fusionStrength}</span></div>
                                            <input type="range" min="0.1" max="0.9" step="0.05" value={fusionStrength} onChange={e => setFusionStrength(e.target.value)} className="w-full mb-1"/>
                                        </div>
                                        <textarea value={fusionPrompt} onChange={e => setFusionPrompt(e.target.value)} className="input-dark w-full h-20 rounded-xl p-3 text-xs resize-none" placeholder="融合提示词 (可选)..."/>
                                    </div>
                                )}

                                {/* Text2Img Controls (Omitted for brevity, same as before) */}
                                {mode === 'text2img' && (
                                    <div className="space-y-6 animate-fade-in">
                                        <textarea value={prompt} onChange={e => setPrompt(e.target.value)} className="input-dark w-full h-32 rounded-xl p-4 text-sm resize-none" placeholder="描述画面内容..."/>
                                        <div className="bg-slate-800/30 p-4 rounded-xl border border-slate-700/50 space-y-3">
                                            <h3 className="text-xs font-bold text-slate-400 uppercase">排版文字</h3>
                                            <input type="text" value={posterTitle} onChange={e => setPosterTitle(e.target.value)} className="input-dark w-full rounded-lg p-2.5 text-sm font-bold" placeholder="主标题"/>
                                            <input type="text" value={posterSubtitle} onChange={e => setPosterSubtitle(e.target.value)} className="input-dark w-full rounded-lg p-2.5 text-xs" placeholder="副标题"/>
                                            <div className="flex justify-between items-center pt-2">
                                                <div className="flex items-center gap-2 bg-slate-900 p-1.5 rounded-lg border border-slate-700"><input type="color" value={textColor} onChange={e => setTextColor(e.target.value)} className="w-5 h-5 rounded cursor-pointer bg-transparent border-none" /></div>
                                                <div className="flex bg-slate-900 rounded-lg p-1 border border-slate-700">
                                                    {['left', 'center', 'right'].map(align => (
                                                        <button key={align} onClick={() => setTextAlign(align)} className={`p-1.5 rounded ${textAlign === align ? 'bg-slate-800 text-white' : 'text-slate-500 hover:text-white'}`}>{align === 'left' ? <AlignLeft size={14}/> : align === 'center' ? <AlignCenter size={14}/> : <AlignRight size={14}/>}</button>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="p-5 border-t border-slate-800 bg-slate-900/50">
                                <button onClick={generateImage} disabled={loading} className={`w-full py-3.5 rounded-xl font-bold shadow-lg disabled:opacity-50 flex justify-center items-center gap-2 transition-all text-white text-sm ${mode === 'fusion' ? 'bg-gradient-to-r from-purple-600 to-pink-600' : 'bg-gradient-to-r from-sky-500 to-blue-600'}`}>
                                    {loading ? <Loader2 size={18} className="animate-spin"/> : <Sparkles size={18}/>}
                                    {loading ? '正在绘制...' : '开始生成'}
                                </button>
                            </div>
                        </div>

                        {/* Right: Canvas Area */}
                        <div className="flex-1 bg-[#020617] relative flex flex-col overflow-hidden">
                            <div className="absolute inset-0 bg-grid-pattern opacity-20 pointer-events-none"></div>
                            
                            {/* Canvas Container - Flex Center */}
                            <div className="flex-1 w-full h-full flex items-center justify-center p-6 lg:p-12 overflow-hidden">
                                
                                {/* Dynamic Canvas (Smart CSS) */}
                                {(!resultImage && !loading && mode === 'fusion') && (
                                    <div 
                                        ref={compositionRef}
                                        className="relative bg-slate-900 border-2 border-dashed border-slate-700 shadow-2xl transition-all duration-300 overflow-hidden"
                                        style={{
                                            ...getAspectRatioStyle(),
                                            maxHeight: '100%',
                                            maxWidth: '100%',
                                            width: 'auto',
                                            height: 'auto',
                                            minWidth: '300px', // Minimum visibility
                                            aspectRatio: getAspectRatioStyle().aspectRatio // Ensure CSS precedence
                                        }}
                                    >
                                        {fusionBg ? (
                                            <img src={fusionBg} className="w-full h-full object-cover pointer-events-none select-none" alt="Background"/>
                                        ) : (
                                            <div className="w-full h-full flex flex-col items-center justify-center text-slate-600 bg-slate-900/50">
                                                <Image size={48} className="mb-4 opacity-10"/>
                                                <p className="text-sm font-medium opacity-50">预览区域</p>
                                            </div>
                                        )}
                                        
                                        {fusionItems.map(item => (
                                            <div
                                                key={item.id}
                                                className={`absolute select-none group ${selectedItemId === item.id ? 'z-50 cursor-move' : 'z-10 cursor-pointer'}`}
                                                style={{
                                                    left: `${item.x}%`, top: `${item.y}%`, width: `${item.scale}%`, transform: 'translate(-50%, -50%)',
                                                }}
                                                onMouseDown={(e) => handleMouseDown(e, item.id, 'move')}
                                                onTouchStart={(e) => handleMouseDown(e, item.id, 'move')}
                                            >
                                                <div className={`relative ${selectedItemId === item.id ? 'ring-2 ring-purple-500 ring-offset-2 ring-offset-transparent' : 'group-hover:ring-1 group-hover:ring-white/30'}`}>
                                                    <img src={item.src} className="w-full h-auto drop-shadow-2xl pointer-events-none" alt="item"/>
                                                    {selectedItemId === item.id && <div className="resize-handle" onMouseDown={(e) => handleMouseDown(e, item.id, 'resize')} onTouchStart={(e) => handleMouseDown(e, item.id, 'resize')} data-html2canvas-ignore="true"/>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {/* Result Image Display */}
                                {resultImage && !loading && (
                                    <div className="flex flex-col gap-6 items-center animate-fade-in w-full h-full justify-center">
                                        <div ref={posterRef} className="relative bg-black shadow-2xl shadow-black/50 overflow-hidden border border-slate-800" 
                                            style={{ 
                                                ...getAspectRatioStyle(),
                                                maxHeight: '85%', 
                                                maxWidth: '100%',
                                                width: 'auto',
                                                height: 'auto'
                                            }}
                                        >
                                            <img src={resultImage} className="w-full h-full object-contain" crossOrigin="anonymous" />
                                            {mode === 'text2img' && (
                                                <div className={`absolute inset-0 flex flex-col justify-end p-10 z-10 text-${textAlign}`}>
                                                    <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent opacity-80"></div>
                                                    <div className="relative z-20 space-y-3">
                                                        <h1 className="text-4xl md:text-5xl font-poster uppercase drop-shadow-xl leading-none tracking-wide" style={{color: textColor, textShadow: '0 4px 30px rgba(0,0,0,0.9)'}}>{posterTitle}</h1>
                                                        <p className="text-xs md:text-sm tracking-[0.4em] uppercase font-light text-white/90">{posterSubtitle}</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        <div className="flex gap-4 shrink-0">
                                            <button onClick={downloadPoster} className="px-6 py-2.5 bg-white text-slate-900 font-bold text-sm rounded-full hover:bg-sky-50 transition-all shadow-lg flex items-center gap-2"><Camera size={18}/> 保存高清海报</button>
                                            <button onClick={() => setResultImage(null)} className="p-2.5 border border-slate-600 rounded-full hover:bg-slate-800 text-slate-300 transition-colors"><Trash2 size={18}/></button>
                                        </div>
                                    </div>
                                )}

                                {/* Loading & Empty States (Same as before) */}
                                {loading && (
                                    <div className="flex flex-col items-center gap-6">
                                        <div className="w-16 h-16 border-4 border-slate-800 border-t-sky-500 rounded-full animate-spin"></div>
                                        <p className="text-sky-200/80 font-medium animate-pulse tracking-wide text-sm uppercase">AI Generating...</p>
                                    </div>
                                )}
                                {mode === 'text2img' && !resultImage && !loading && (
                                    <div className="text-center text-slate-600">
                                        <Box size={48} className="mx-auto mb-4 opacity-20"/>
                                        <p className="text-sm font-medium">准备就绪</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


