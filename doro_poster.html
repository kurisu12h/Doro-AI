<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doro AI Poster Pro - 专业海报工坊</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>

    <style>
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fade-in-up 0.6s ease-out forwards; }
        .animate-fade-in { animation: fade-in-up 0.4s ease-out forwards; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .font-poster { font-family: 'Impact', 'Arial Black', sans-serif; letter-spacing: 0.05em; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* 隐藏数字输入框箭头 */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-slate-950 overflow-x-hidden text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Image, Settings, Sparkles, Download, AlertCircle, Loader2, Key, Palette, Trash2, LayoutTemplate, Camera, ChevronLeft, Type, AlignCenter, AlignLeft, AlignRight, Pipette, Maximize, Smartphone, Monitor, Square, Ratio, MoveDiagonal } from 'lucide-react';

        const App = () => {
            // 基础配置
            const [apiKey, setApiKey] = useState('');
            const [baseUrl, setBaseUrl] = useState('https://api.bltcy.ai/v1');
            const [prompt, setPrompt] = useState('');
            const [loading, setLoading] = useState(false);
            const [resultImage, setResultImage] = useState(null);
            const [error, setError] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            
            // 尺寸配置
            const [sizeMode, setSizeMode] = useState('preset'); // 'preset' | 'custom'
            const [presetSize, setPresetSize] = useState('768x1024'); // 默认 3:4
            const [customW, setCustomW] = useState('768');
            const [customH, setCustomH] = useState('1024');

            // 海报专属配置
            const [posterTitle, setPosterTitle] = useState('CINEMATIC VIEW');
            const [posterSubtitle, setPosterSubtitle] = useState('AI GENERATED MASTERPIECE');
            const [textColor, setTextColor] = useState('#ffffff');
            const [textAlign, setTextAlign] = useState('center'); // center, left, right
            const posterRef = useRef(null);

            useEffect(() => {
                const storedKey = localStorage.getItem('plato_api_key');
                const storedBaseUrl = localStorage.getItem('plato_base_url');
                if (storedKey) setApiKey(storedKey);
                if (storedBaseUrl) setBaseUrl(storedBaseUrl);
            }, []);

            const generateImage = async () => {
                if (!apiKey) { setShowSettings(true); return setError('请先配置 API Key'); }
                if (!prompt) return setError('请输入提示词');
                setLoading(true); setError(''); setResultImage(null);

                try {
                    const cleanBaseUrl = baseUrl.replace(/\/$/, '');
                    const isV1Included = cleanBaseUrl.endsWith('/v1');
                    const endpoint = isV1Included ? `${cleanBaseUrl}/images/generations` : `${cleanBaseUrl}/v1/images/generations`;

                    // 计算最终尺寸
                    const finalSize = sizeMode === 'custom' ? `${customW}x${customH}` : presetSize;
                    console.log("Generating size:", finalSize);

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify({ 
                            model: 'nano-banana', 
                            prompt: prompt, 
                            n: 1, 
                            size: finalSize 
                        })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error?.message || '生成失败');
                    if (data.data && data.data.length > 0) setResultImage(data.data[0].url);
                } catch (err) { setError(err.message); } finally { setLoading(false); }
            };

            const downloadPoster = async () => {
                if (!posterRef.current) return;
                try {
                    const canvas = await html2canvas(posterRef.current, { useCORS: true, scale: 2, backgroundColor: '#000' });
                    const link = document.createElement('a');
                    link.download = `doro-poster-pro-${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (e) {
                    setError("海报保存失败，请尝试右键保存图片。");
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-b from-slate-900 to-black pb-10">
                    {/* Header */}
                    <nav className="border-b border-white/10 bg-black/40 backdrop-blur-md sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <a href="doro_ai_local.html" className="p-2 hover:bg-white/10 rounded-full transition-colors" title="返回主页">
                                    <ChevronLeft size={24} />
                                </a>
                                <div className="flex items-center gap-2">
                                    <div className="bg-gradient-to-tr from-blue-500 to-cyan-500 p-2 rounded-lg">
                                        <LayoutTemplate size={20} className="text-white" />
                                    </div>
                                    <span className="font-bold text-xl tracking-tight">Doro Poster <span className="text-cyan-400 font-light">Pro</span></span>
                                </div>
                            </div>
                            <button onClick={() => setShowSettings(!showSettings)} className="text-sm text-gray-400 hover:text-white flex items-center gap-2">
                                <Settings size={16} /> 设置 API
                            </button>
                        </div>
                    </nav>

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-slate-900 border border-white/10 rounded-2xl p-6 w-full max-w-md shadow-2xl">
                                <h3 className="font-bold mb-2">API 配置</h3>
                                <p className="text-xs text-gray-500 mb-4">与主页配置自动同步，一般无需修改。</p>
                                <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="API Key" className="w-full bg-black/50 border border-white/10 rounded p-2 mb-4 text-sm" />
                                <input type="text" value={baseUrl} onChange={e => setBaseUrl(e.target.value)} placeholder="Base URL" className="w-full bg-black/50 border border-white/10 rounded p-2 mb-4 text-sm" />
                                <button onClick={() => {
                                    localStorage.setItem('plato_api_key', apiKey);
                                    localStorage.setItem('plato_base_url', baseUrl);
                                    setShowSettings(false);
                                }} className="w-full bg-cyan-600 hover:bg-cyan-500 py-2 rounded font-bold">保存</button>
                            </div>
                        </div>
                    )}

                    <main className="max-w-7xl mx-auto px-4 py-8 flex flex-col lg:flex-row gap-8">
                        {/* Left: Controls */}
                        <div className="w-full lg:w-1/3 space-y-6 animate-fade-in-up">
                            
                            {/* Panel 1: Text */}
                            <div className="bg-white/5 border border-white/10 rounded-2xl p-6 backdrop-blur-sm">
                                <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-cyan-400"><Type size={18}/> 海报文字</h2>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-xs text-gray-400 uppercase tracking-wider block mb-1">主标题</label>
                                        <input type="text" value={posterTitle} onChange={e => setPosterTitle(e.target.value)} className="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-lg font-bold tracking-wider focus:border-cyan-500 outline-none" />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-400 uppercase tracking-wider block mb-1">副标题</label>
                                        <input type="text" value={posterSubtitle} onChange={e => setPosterSubtitle(e.target.value)} className="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-sm tracking-widest focus:border-cyan-500 outline-none" />
                                    </div>
                                    
                                    {/* Style Controls */}
                                    <div className="grid grid-cols-2 gap-4 pt-2">
                                        <div>
                                            <label className="text-xs text-gray-400 uppercase tracking-wider block mb-1 flex items-center gap-1"><Pipette size={12}/> 文字颜色</label>
                                            <div className="flex items-center gap-2 bg-black/40 p-1 rounded-lg border border-white/10">
                                                <input type="color" value={textColor} onChange={e => setTextColor(e.target.value)} className="w-8 h-8 rounded cursor-pointer bg-transparent border-none" />
                                                <span className="text-xs font-mono text-gray-400">{textColor}</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-400 uppercase tracking-wider block mb-1">对齐方式</label>
                                            <div className="flex bg-black/40 rounded-lg border border-white/10 p-1">
                                                <button onClick={() => setTextAlign('left')} className={`flex-1 p-2 rounded ${textAlign === 'left' ? 'bg-white/20' : 'hover:bg-white/5'}`}><AlignLeft size={16} className="mx-auto"/></button>
                                                <button onClick={() => setTextAlign('center')} className={`flex-1 p-2 rounded ${textAlign === 'center' ? 'bg-white/20' : 'hover:bg-white/5'}`}><AlignCenter size={16} className="mx-auto"/></button>
                                                <button onClick={() => setTextAlign('right')} className={`flex-1 p-2 rounded ${textAlign === 'right' ? 'bg-white/20' : 'hover:bg-white/5'}`}><AlignRight size={16} className="mx-auto"/></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Panel 2: Image & Size */}
                            <div className="bg-white/5 border border-white/10 rounded-2xl p-6 backdrop-blur-sm flex flex-col gap-6">
                                <h2 className="text-lg font-bold flex items-center gap-2 text-purple-400"><Sparkles size={18}/> 画面生成</h2>
                                
                                {/* Size Selector */}
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center">
                                        <label className="text-xs text-gray-400 uppercase tracking-wider flex items-center gap-1.5">
                                            <Maximize size={14} className="text-gray-400"/> 画布尺寸
                                        </label>
                                        <div className="flex bg-black/40 rounded-lg p-0.5 border border-white/10">
                                            <button 
                                                onClick={() => setSizeMode('preset')} 
                                                className={`px-3 py-1 text-[10px] rounded-md transition-all ${sizeMode === 'preset' ? 'bg-white/20 text-white font-bold' : 'text-gray-500 hover:text-gray-300'}`}
                                            >预设</button>
                                            <button 
                                                onClick={() => setSizeMode('custom')} 
                                                className={`px-3 py-1 text-[10px] rounded-md transition-all ${sizeMode === 'custom' ? 'bg-white/20 text-white font-bold' : 'text-gray-500 hover:text-gray-300'}`}
                                            >自定义</button>
                                        </div>
                                    </div>

                                    {sizeMode === 'preset' ? (
                                        <div className="grid grid-cols-3 gap-2">
                                            {[
                                                { label: '海报 2:3', val: '768x1152', icon: <Ratio size={14} className="text-cyan-400"/> },
                                                { label: '标准 3:4', val: '768x1024', icon: <MoveDiagonal size={14} className="text-blue-400"/> },
                                                { label: '手机 9:16', val: '576x1024', icon: <Smartphone size={14} className="text-purple-400"/> },
                                                { label: '方形 1:1', val: '1024x1024', icon: <Square size={14} className="text-pink-400"/> },
                                                { label: '横版 4:3', val: '1024x768', icon: <Ratio size={14} className="rotate-90 text-green-400"/> },
                                                { label: '宽屏 16:9', val: '1024x576', icon: <Monitor size={14} className="text-orange-400"/> },
                                            ].map((s) => (
                                                <button
                                                    key={s.val}
                                                    onClick={() => setPresetSize(s.val)}
                                                    className={`flex flex-col items-center justify-center p-2 rounded-lg border transition-all ${presetSize === s.val ? 'bg-white/10 border-cyan-500/50 text-white shadow-[0_0_10px_rgba(6,182,212,0.2)]' : 'bg-black/40 border-transparent hover:bg-white/5 text-gray-500'}`}
                                                >
                                                    <div className="mb-1 opacity-80">{s.icon}</div>
                                                    <span className="text-[10px] scale-90">{s.label}</span>
                                                </button>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="flex items-center gap-2 bg-black/20 p-2 rounded-lg border border-white/5">
                                            <div className="relative flex-1">
                                                <span className="absolute left-3 top-2.5 text-gray-500 text-xs font-mono">W</span>
                                                <input 
                                                    type="number" 
                                                    value={customW} 
                                                    onChange={(e) => setCustomW(e.target.value)} 
                                                    className="w-full bg-black/40 border border-white/10 rounded-md py-2 pl-8 pr-2 text-sm text-center focus:border-cyan-500 outline-none transition-colors"
                                                />
                                            </div>
                                            <span className="text-gray-600 font-bold">×</span>
                                            <div className="relative flex-1">
                                                <span className="absolute left-3 top-2.5 text-gray-500 text-xs font-mono">H</span>
                                                <input 
                                                    type="number" 
                                                    value={customH} 
                                                    onChange={(e) => setCustomH(e.target.value)} 
                                                    className="w-full bg-black/40 border border-white/10 rounded-md py-2 pl-8 pr-2 text-sm text-center focus:border-cyan-500 outline-none transition-colors"
                                                />
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <textarea 
                                    value={prompt} 
                                    onChange={e => setPrompt(e.target.value)} 
                                    placeholder="描述海报背景画面，例如：未来城市的赛博朋克街道，雨夜..." 
                                    className="w-full h-32 bg-black/40 border border-white/10 rounded-lg p-3 text-sm focus:border-purple-500 outline-none resize-none"
                                />
                                <button 
                                    onClick={generateImage} 
                                    disabled={loading}
                                    className="w-full py-4 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 rounded-xl font-bold shadow-lg shadow-cyan-500/20 disabled:opacity-50 flex justify-center items-center gap-2 transition-all"
                                >
                                    {loading ? <Loader2 size={20} className="animate-spin"/> : <Sparkles size={20}/>}
                                    {loading ? 'AI 绘制中...' : '生成海报背景'}
                                </button>
                            </div>
                        </div>

                        {/* Right: Canvas */}
                        <div className="w-full lg:w-2/3 flex items-start justify-center min-h-[600px] bg-black/20 rounded-2xl border border-white/10 relative overflow-hidden">
                             <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'radial-gradient(#ffffff 1px, transparent 1px)', backgroundSize: '24px 24px'}}></div>
                             
                             <div className="relative p-8 w-full flex flex-col items-center">
                                {resultImage ? (
                                    <div className="flex flex-col gap-6 animate-fade-in w-full max-w-2xl">
                                        <div 
                                            ref={posterRef}
                                            className="relative w-full bg-black shadow-2xl shadow-cyan-900/20 overflow-hidden mx-auto"
                                            style={{
                                                aspectRatio: sizeMode === 'custom' ? `${customW}/${customH}` : presetSize.replace('x', '/')
                                            }}
                                        >
                                            <img src={resultImage} className="w-full h-full object-cover opacity-90" crossOrigin="anonymous" />
                                            
                                            {/* Poster Overlay */}
                                            <div className={`absolute inset-0 flex flex-col justify-end p-8 md:p-12 z-10 text-${textAlign}`}>
                                                <div className="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent opacity-80"></div>
                                                <div className="relative z-20 space-y-2">
                                                    <h1 className="text-5xl md:text-7xl font-poster uppercase drop-shadow-2xl leading-none" style={{color: textColor, textShadow: '0 4px 20px rgba(0,0,0,0.8)'}}>
                                                        {posterTitle}
                                                    </h1>
                                                    <p className="text-sm md:text-base tracking-[0.3em] uppercase font-light text-white/80 drop-shadow-lg">
                                                        {posterSubtitle}
                                                    </p>
                                                </div>
                                                <div className="absolute inset-6 border border-white/20 pointer-events-none"></div>
                                            </div>
                                        </div>

                                        <div className="flex justify-center gap-4">
                                            <button onClick={downloadPoster} className="px-8 py-3 bg-white text-black font-bold rounded-full hover:bg-gray-200 transition-colors flex items-center gap-2">
                                                <Camera size={20}/> 保存海报
                                            </button>
                                            <button onClick={() => setResultImage(null)} className="p-3 border border-white/20 rounded-full hover:bg-white/10 text-white transition-colors">
                                                <Trash2 size={20}/>
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex flex-col items-center justify-center h-[500px] text-gray-500">
                                        {error ? (
                                            <div className="text-red-400 flex flex-col items-center">
                                                <AlertCircle size={40} className="mb-2"/>
                                                <p>{error}</p>
                                            </div>
                                        ) : (
                                            <>
                                                <LayoutTemplate size={64} className="mb-4 opacity-20"/>
                                                <p>在左侧选择尺寸，输入提示词，设计你的大片海报</p>
                                            </>
                                        )}
                                    </div>
                                )}
                             </div>
                        </div>
                    </main>
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
