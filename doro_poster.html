<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doro AI Poster Pro - 专业海报工坊</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>

    <style>
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fade-in-up 0.6s ease-out forwards; }
        .animate-fade-in { animation: fade-in-up 0.4s ease-out forwards; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .font-poster { font-family: 'Impact', 'Arial Black', sans-serif; letter-spacing: 0.05em; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* 滑块自定义 */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: #22d3ee; margin-top: -5px; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #334155; border-radius: 2px; }
    </style>
</head>
<body class="bg-slate-950 overflow-x-hidden text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Image, Settings, Sparkles, Download, AlertCircle, Loader2, Key, Palette, Trash2, LayoutTemplate, Camera, ChevronLeft, Type, AlignCenter, AlignLeft, AlignRight, Pipette, Maximize, Smartphone, Monitor, Square, Ratio, MoveDiagonal, Layers, Plus, Box, Upload, ArrowRight } from 'lucide-react';

        const App = () => {
            // --- 基础状态 ---
            const [apiKey, setApiKey] = useState('');
            const [baseUrl, setBaseUrl] = useState('https://api.bltcy.ai/v1');
            const [showSettings, setShowSettings] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [resultImage, setResultImage] = useState(null); // 最终生成的图

            // --- 模式切换 ---
            const [mode, setMode] = useState('text2img'); // 'text2img' | 'fusion'

            // --- Text2Img 模式状态 ---
            const [prompt, setPrompt] = useState('');
            const [sizeMode, setSizeMode] = useState('preset');
            const [presetSize, setPresetSize] = useState('768x1024');
            const [customW, setCustomW] = useState('768');
            const [customH, setCustomH] = useState('1024');

            // --- Fusion 模式状态 ---
            const [fusionBg, setFusionBg] = useState(null); // 背景图 Base64
            const [fusionItems, setFusionItems] = useState([]); // 物品列表 [{id, src, x, y, scale}]
            const [selectedItemId, setSelectedItemId] = useState(null);
            const [fusionPrompt, setFusionPrompt] = useState('high quality, realistic lighting, perfect shadows, seamless blending');
            const [fusionStrength, setFusionStrength] = useState(0.55); // 融合度
            const fileInputBgRef = useRef(null);
            const fileInputItemRef = useRef(null);
            const compositionRef = useRef(null); // 用于截图拼贴

            // --- 海报文字状态 ---
            const [posterTitle, setPosterTitle] = useState('CINEMATIC VIEW');
            const [posterSubtitle, setPosterSubtitle] = useState('AI GENERATED MASTERPIECE');
            const [textColor, setTextColor] = useState('#ffffff');
            const [textAlign, setTextAlign] = useState('center');
            const posterRef = useRef(null); // 用于最终海报截图

            // 初始化
            useEffect(() => {
                const storedKey = localStorage.getItem('plato_api_key');
                const storedBaseUrl = localStorage.getItem('plato_base_url');
                if (storedKey) setApiKey(storedKey);
                if (storedBaseUrl) setBaseUrl(storedBaseUrl);
            }, []);

            // --- Fusion 逻辑 ---
            const handleBgUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onloadend = () => setFusionBg(reader.result);
                reader.readAsDataURL(file);
            };

            const handleItemUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (fusionItems.length >= 5) return setError('最多只能添加 5 个物品');
                const reader = new FileReader();
                reader.onloadend = () => {
                    const newItem = {
                        id: Date.now(),
                        src: reader.result,
                        x: 50, // %
                        y: 50, // %
                        scale: 30 // % width relative to container
                    };
                    setFusionItems([...fusionItems, newItem]);
                    setSelectedItemId(newItem.id);
                };
                reader.readAsDataURL(file);
            };

            const updateItem = (id, key, value) => {
                setFusionItems(items => items.map(item => 
                    item.id === id ? { ...item, [key]: parseFloat(value) } : item
                ));
            };

            const deleteItem = (id) => {
                setFusionItems(items => items.filter(i => i.id !== id));
                if (selectedItemId === id) setSelectedItemId(null);
            };

            // --- 生成逻辑 ---
            const generateImage = async () => {
                if (!apiKey) { setShowSettings(true); return setError('请先配置 API Key'); }
                setLoading(true); setError(''); setResultImage(null);

                try {
                    const cleanBaseUrl = baseUrl.replace(/\/$/, '');
                    const isV1Included = cleanBaseUrl.endsWith('/v1');
                    const endpoint = isV1Included ? `${cleanBaseUrl}/images/generations` : `${cleanBaseUrl}/v1/images/generations`;

                    let payload = {
                        model: 'nano-banana',
                        n: 1,
                        size: sizeMode === 'custom' ? `${customW}x${customH}` : presetSize
                    };

                    if (mode === 'fusion') {
                        if (!fusionBg) throw new Error("请先上传环境背景图");
                        
                        // 1. 合成拼贴图
                        if (!compositionRef.current) throw new Error("拼贴区域未加载");
                        const canvas = await html2canvas(compositionRef.current, { 
                            useCORS: true, 
                            backgroundColor: null,
                            scale: 1 // 不需要太高清，作为底图即可
                        });
                        const compositeBase64 = canvas.toDataURL('image/png').split(',')[1];

                        // 2. 构建图生图请求
                        payload.prompt = fusionPrompt;
                        payload.image = compositeBase64;
                        payload.strength = parseFloat(fusionStrength); // 关键参数
                        console.log("Fusion Mode: Sending composite image with strength", fusionStrength);
                    } else {
                        // Text2Img Mode
                        if (!prompt) throw new Error("请输入提示词");
                        payload.prompt = prompt;
                    }

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error?.message || '生成失败');
                    if (data.data && data.data.length > 0) setResultImage(data.data[0].url);

                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const downloadPoster = async () => {
                if (!posterRef.current) return;
                try {
                    const canvas = await html2canvas(posterRef.current, { useCORS: true, scale: 2, backgroundColor: '#000' });
                    const link = document.createElement('a');
                    link.download = `doro-poster-pro-${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (e) {
                    setError("海报保存失败，请尝试右键保存图片。");
                }
            };

            // --- 渲染部分 ---
            return (
                <div className="min-h-screen bg-gradient-to-b from-slate-900 to-black pb-10 text-slate-200">
                    {/* Header */}
                    <nav className="border-b border-white/10 bg-black/40 backdrop-blur-md sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <a href="index.html" className="p-2 hover:bg-white/10 rounded-full transition-colors" title="返回主页"><ChevronLeft size={24} /></a>
                                <div className="flex items-center gap-2">
                                    <div className="bg-gradient-to-tr from-blue-500 to-cyan-500 p-2 rounded-lg">
                                        <LayoutTemplate size={20} className="text-white" />
                                    </div>
                                    <span className="font-bold text-xl tracking-tight text-white">Doro Poster <span className="text-cyan-400 font-light">Pro</span></span>
                                </div>
                            </div>
                            <button onClick={() => setShowSettings(!showSettings)} className="text-sm text-gray-400 hover:text-white flex items-center gap-2">
                                <Settings size={16} /> 设置 API
                            </button>
                        </div>
                    </nav>

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-slate-900 border border-white/10 rounded-2xl p-6 w-full max-w-md shadow-2xl animate-fade-in">
                                <h3 className="font-bold mb-2 text-white">API 配置</h3>
                                <p className="text-xs text-gray-500 mb-4">与主页配置自动同步。</p>
                                <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="API Key" className="w-full bg-black/50 border border-white/10 rounded p-2 mb-4 text-sm" />
                                <input type="text" value={baseUrl} onChange={e => setBaseUrl(e.target.value)} placeholder="Base URL" className="w-full bg-black/50 border border-white/10 rounded p-2 mb-4 text-sm" />
                                <button onClick={() => {
                                    localStorage.setItem('plato_api_key', apiKey);
                                    localStorage.setItem('plato_base_url', baseUrl);
                                    setShowSettings(false);
                                }} className="w-full bg-cyan-600 hover:bg-cyan-500 text-white py-2 rounded font-bold">保存</button>
                            </div>
                        </div>
                    )}

                    <main className="max-w-7xl mx-auto px-4 py-8 flex flex-col lg:flex-row gap-8">
                        {/* Left Column: Controls */}
                        <div className="w-full lg:w-1/3 space-y-6 animate-fade-in-up">
                            
                            {/* 1. Mode Switcher */}
                            <div className="bg-white/5 p-1 rounded-xl flex border border-white/10">
                                <button 
                                    onClick={() => setMode('text2img')}
                                    className={`flex-1 py-2 text-sm font-bold rounded-lg flex items-center justify-center gap-2 transition-all ${mode === 'text2img' ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-400 hover:text-white'}`}
                                >
                                    <Sparkles size={16}/> 文生海报
                                </button>
                                <button 
                                    onClick={() => setMode('fusion')}
                                    className={`flex-1 py-2 text-sm font-bold rounded-lg flex items-center justify-center gap-2 transition-all ${mode === 'fusion' ? 'bg-purple-600 text-white shadow-lg' : 'text-gray-400 hover:text-white'}`}
                                >
                                    <Layers size={16}/> 物品融合 <span className="text-[10px] bg-white/20 px-1 rounded">NEW</span>
                                </button>
                            </div>

                            {/* 2. Main Control Panel based on Mode */}
                            <div className="bg-white/5 border border-white/10 rounded-2xl p-6 backdrop-blur-sm flex flex-col gap-6">
                                
                                {mode === 'text2img' ? (
                                    <>
                                        {/* Text2Img Controls */}
                                        <div>
                                            <div className="flex justify-between items-center mb-2">
                                                <label className="text-xs text-gray-400 uppercase tracking-wider flex items-center gap-1.5"><Maximize size={14}/> 画布尺寸</label>
                                                <div className="flex bg-black/40 rounded-lg p-0.5 border border-white/10">
                                                    <button onClick={() => setSizeMode('preset')} className={`px-2 py-1 text-[10px] rounded ${sizeMode === 'preset' ? 'bg-white/20 text-white' : 'text-gray-500'}`}>预设</button>
                                                    <button onClick={() => setSizeMode('custom')} className={`px-2 py-1 text-[10px] rounded ${sizeMode === 'custom' ? 'bg-white/20 text-white' : 'text-gray-500'}`}>自定义</button>
                                                </div>
                                            </div>
                                            {sizeMode === 'preset' ? (
                                                <select value={presetSize} onChange={e => setPresetSize(e.target.value)} className="w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-blue-500">
                                                    <option value="768x1152">海报 2:3</option>
                                                    <option value="768x1024">标准 3:4</option>
                                                    <option value="576x1024">手机 9:16</option>
                                                    <option value="1024x1024">方形 1:1</option>
                                                </select>
                                            ) : (
                                                <div className="flex gap-2">
                                                    <input type="number" value={customW} onChange={e => setCustomW(e.target.value)} className="w-1/2 bg-black/40 border border-white/10 rounded p-2 text-sm text-center text-white" placeholder="W"/>
                                                    <input type="number" value={customH} onChange={e => setCustomH(e.target.value)} className="w-1/2 bg-black/40 border border-white/10 rounded p-2 text-sm text-center text-white" placeholder="H"/>
                                                </div>
                                            )}
                                        </div>
                                        
                                        <div>
                                            <label className="text-xs text-gray-400 uppercase tracking-wider block mb-2">提示词</label>
                                            <textarea 
                                                value={prompt} 
                                                onChange={e => setPrompt(e.target.value)} 
                                                placeholder="描述画面内容..." 
                                                className="w-full h-32 bg-black/40 border border-white/10 rounded-lg p-3 text-sm text-white focus:border-blue-500 outline-none resize-none"
                                            />
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        {/* Fusion Mode Controls */}
                                        <div className="space-y-4">
                                            {/* Background Upload */}
                                            <div>
                                                <label className="text-xs text-gray-400 uppercase tracking-wider mb-2 flex justify-between">
                                                    <span>1. 环境背景图</span>
                                                    {fusionBg && <span className="text-green-400 flex items-center gap-1 text-[10px]"><Sparkles size={10}/> 已就绪</span>}
                                                </label>
                                                <div onClick={() => fileInputBgRef.current?.click()} className={`border-2 border-dashed rounded-lg p-3 flex flex-col items-center justify-center cursor-pointer transition-all h-24 relative overflow-hidden ${fusionBg ? 'border-purple-500/50' : 'border-white/10 hover:border-white/30 hover:bg-white/5'}`}>
                                                    {fusionBg ? (
                                                        <img src={fusionBg} className="absolute inset-0 w-full h-full object-cover opacity-50" />
                                                    ) : (
                                                        <div className="text-gray-500 flex flex-col items-center"><Image size={20} className="mb-1"/><span className="text-xs">点击上传背景</span></div>
                                                    )}
                                                    {fusionBg && <div className="relative z-10 bg-black/60 px-2 py-1 rounded text-xs">点击更换</div>}
                                                    <input type="file" ref={fileInputBgRef} className="hidden" accept="image/*" onChange={handleBgUpload}/>
                                                </div>
                                            </div>

                                            {/* Items Upload */}
                                            <div>
                                                <label className="text-xs text-gray-400 uppercase tracking-wider mb-2 flex justify-between">
                                                    <span>2. 添加物品 (最多5个)</span>
                                                    <span className="text-gray-500">{fusionItems.length}/5</span>
                                                </label>
                                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                                    <button onClick={() => fileInputItemRef.current?.click()} disabled={fusionItems.length >= 5} className="w-16 h-16 flex-shrink-0 border border-white/10 bg-white/5 rounded-lg flex items-center justify-center hover:bg-white/10 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                                        <Plus size={20} className="text-gray-400"/>
                                                    </button>
                                                    {fusionItems.map((item, idx) => (
                                                        <div key={item.id} onClick={() => setSelectedItemId(item.id)} className={`w-16 h-16 flex-shrink-0 rounded-lg border relative overflow-hidden cursor-pointer transition-all ${selectedItemId === item.id ? 'border-purple-500 ring-2 ring-purple-500/30' : 'border-white/10'}`}>
                                                            <img src={item.src} className="w-full h-full object-cover"/>
                                                            <div className="absolute top-0 left-0 bg-black/60 text-[8px] px-1">{idx + 1}</div>
                                                        </div>
                                                    ))}
                                                    <input type="file" ref={fileInputItemRef} className="hidden" accept="image/*" onChange={handleItemUpload}/>
                                                </div>
                                            </div>

                                            {/* Active Item Adjustments */}
                                            {selectedItemId && (
                                                <div className="bg-black/20 rounded-lg p-3 border border-white/5 animate-fade-in">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <span className="text-xs text-purple-300 font-bold">调整物品 #{fusionItems.findIndex(i => i.id === selectedItemId) + 1}</span>
                                                        <button onClick={() => deleteItem(selectedItemId)} className="text-red-400 hover:text-red-300"><Trash2 size={12}/></button>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-3">
                                                        <div>
                                                            <label className="text-[10px] text-gray-500 block">大小 (Scale)</label>
                                                            <input type="range" min="5" max="80" value={fusionItems.find(i => i.id === selectedItemId)?.scale || 30} onChange={(e) => updateItem(selectedItemId, 'scale', e.target.value)} className="w-full"/>
                                                        </div>
                                                        <div>
                                                            <label className="text-[10px] text-gray-500 block">X 轴位置</label>
                                                            <input type="range" min="0" max="100" value={fusionItems.find(i => i.id === selectedItemId)?.x || 50} onChange={(e) => updateItem(selectedItemId, 'x', e.target.value)} className="w-full"/>
                                                        </div>
                                                        <div className="col-span-2">
                                                            <label className="text-[10px] text-gray-500 block">Y 轴位置</label>
                                                            <input type="range" min="0" max="100" value={fusionItems.find(i => i.id === selectedItemId)?.y || 50} onChange={(e) => updateItem(selectedItemId, 'y', e.target.value)} className="w-full"/>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Fusion Settings */}
                                            <div className="pt-2 border-t border-white/10">
                                                <div className="flex justify-between mb-1">
                                                    <label className="text-xs text-gray-400 uppercase">3. AI 融合程度</label>
                                                    <span className="text-xs text-purple-400 font-mono">{fusionStrength}</span>
                                                </div>
                                                <input type="range" min="0.1" max="0.9" step="0.05" value={fusionStrength} onChange={e => setFusionStrength(e.target.value)} className="w-full mb-1"/>
                                                <p className="text-[10px] text-gray-500 flex justify-between">
                                                    <span>保留原样</span>
                                                    <span>完全重绘</span>
                                                </p>
                                            </div>

                                            <div>
                                                <label className="text-xs text-gray-400 uppercase block mb-2">融合提示词 (可选)</label>
                                                <textarea 
                                                    value={fusionPrompt} 
                                                    onChange={e => setFusionPrompt(e.target.value)} 
                                                    className="w-full h-20 bg-black/40 border border-white/10 rounded-lg p-3 text-xs text-white focus:border-purple-500 outline-none resize-none"
                                                />
                                            </div>
                                        </div>
                                    </>
                                )}

                                {/* Generate Button */}
                                <button 
                                    onClick={generateImage} 
                                    disabled={loading}
                                    className={`w-full py-4 rounded-xl font-bold shadow-lg disabled:opacity-50 flex justify-center items-center gap-2 transition-all text-white ${
                                        mode === 'fusion' 
                                        ? 'bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 shadow-purple-500/20' 
                                        : 'bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 shadow-blue-500/20'
                                    }`}
                                >
                                    {loading ? <Loader2 size={20} className="animate-spin"/> : <Sparkles size={20}/>}
                                    {loading ? 'AI 处理中...' : (mode === 'fusion' ? '开始融合生成' : '生成海报背景')}
                                </button>
                            </div>

                            {/* Panel 3: Poster Text (Shared) */}
                            <div className="bg-white/5 border border-white/10 rounded-2xl p-6 backdrop-blur-sm">
                                <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-gray-200"><Type size={18}/> 文字排版</h2>
                                <div className="space-y-4">
                                    <input type="text" value={posterTitle} onChange={e => setPosterTitle(e.target.value)} className="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-lg font-bold tracking-wider focus:border-gray-500 outline-none text-white" placeholder="主标题"/>
                                    <input type="text" value={posterSubtitle} onChange={e => setPosterSubtitle(e.target.value)} className="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-sm tracking-widest focus:border-gray-500 outline-none text-white" placeholder="副标题"/>
                                    <div className="flex justify-between items-center pt-2">
                                        <div className="flex items-center gap-2">
                                            <Pipette size={14} className="text-gray-400"/>
                                            <input type="color" value={textColor} onChange={e => setTextColor(e.target.value)} className="w-6 h-6 rounded cursor-pointer bg-transparent border-none" />
                                        </div>
                                        <div className="flex bg-black/40 rounded-lg p-1 border border-white/10">
                                            {['left', 'center', 'right'].map(align => (
                                                <button key={align} onClick={() => setTextAlign(align)} className={`p-1.5 rounded ${textAlign === align ? 'bg-white/20' : 'hover:bg-white/5'}`}>
                                                    {align === 'left' ? <AlignLeft size={14}/> : align === 'center' ? <AlignCenter size={14}/> : <AlignRight size={14}/>}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Right Column: Preview & Canvas */}
                        <div className="w-full lg:w-2/3 min-h-[600px] bg-black/20 rounded-2xl border border-white/10 relative flex flex-col items-center justify-center p-8">
                             <div className="absolute inset-0 opacity-10 pointer-events-none" style={{backgroundImage: 'radial-gradient(#ffffff 1px, transparent 1px)', backgroundSize: '24px 24px'}}></div>
                             
                             {/* Preview Area */}
                             {mode === 'fusion' && !resultImage && (
                                <div className="w-full max-w-xl mb-4">
                                    <div className="text-xs text-gray-400 mb-2 uppercase tracking-wider flex justify-between">
                                        <span>拼贴预览 (AI 将以此为底图进行重绘)</span>
                                        <span>{fusionItems.length} items</span>
                                    </div>
                                    <div 
                                        ref={compositionRef}
                                        className="relative w-full aspect-[3/4] bg-black/50 border border-white/10 rounded-lg overflow-hidden shadow-2xl mx-auto"
                                    >
                                        {fusionBg ? (
                                            <img src={fusionBg} className="w-full h-full object-cover" alt="Background"/>
                                        ) : (
                                            <div className="w-full h-full flex flex-col items-center justify-center text-gray-600">
                                                <Image size={48} className="mb-2 opacity-20"/>
                                                <p className="text-sm">请在左侧上传环境背景</p>
                                            </div>
                                        )}
                                        
                                        {/* Render Fusion Items */}
                                        {fusionItems.map(item => (
                                            <div
                                                key={item.id}
                                                className={`absolute transition-all ${selectedItemId === item.id ? 'ring-2 ring-purple-500 z-50' : 'z-10'}`}
                                                style={{
                                                    left: `${item.x}%`,
                                                    top: `${item.y}%`,
                                                    width: `${item.scale}%`,
                                                    transform: 'translate(-50%, -50%)',
                                                    cursor: 'move' 
                                                }}
                                                // Simple click to select, real drag requires more code, using sliders for stability
                                                onClick={(e) => { e.stopPropagation(); setSelectedItemId(item.id); }}
                                            >
                                                <img src={item.src} className="w-full h-auto drop-shadow-lg" alt="item"/>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                             )}

                             {/* Result Area (Standard Text2Img or Fusion Result) */}
                             {(mode === 'text2img' || resultImage) && (
                                 <div className="w-full max-w-2xl flex flex-col gap-6 animate-fade-in">
                                    {loading ? (
                                        <div className="flex flex-col items-center gap-4 py-20">
                                            <div className="w-16 h-16 border-4 border-white/10 border-t-blue-500 rounded-full animate-spin"></div>
                                            <p className="text-blue-200 animate-pulse">AI 正在{mode === 'fusion' ? '融合绘制' : '生成'}中...</p>
                                        </div>
                                    ) : resultImage ? (
                                        <>
                                            <div 
                                                ref={posterRef}
                                                className="relative w-full bg-black shadow-2xl shadow-black/50 overflow-hidden mx-auto group"
                                                style={{
                                                    aspectRatio: mode === 'text2img' ? (sizeMode === 'custom' ? `${customW}/${customH}` : presetSize.replace('x', '/')) : 'auto'
                                                }}
                                            >
                                                <img src={resultImage} className="w-full h-full object-contain bg-gray-900" crossOrigin="anonymous" />
                                                
                                                {/* Poster Overlay Text */}
                                                <div className={`absolute inset-0 flex flex-col justify-end p-8 md:p-12 z-10 text-${textAlign}`}>
                                                    <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-90"></div>
                                                    <div className="relative z-20 space-y-2">
                                                        <h1 className="text-5xl md:text-7xl font-poster uppercase drop-shadow-2xl leading-none" style={{color: textColor, textShadow: '0 4px 20px rgba(0,0,0,0.8)'}}>
                                                            {posterTitle}
                                                        </h1>
                                                        <p className="text-sm md:text-base tracking-[0.3em] uppercase font-light text-white/80 drop-shadow-lg">
                                                            {posterSubtitle}
                                                        </p>
                                                    </div>
                                                    <div className="absolute inset-6 border border-white/20 pointer-events-none"></div>
                                                </div>
                                            </div>

                                            <div className="flex justify-center gap-4">
                                                <button onClick={downloadPoster} className="px-8 py-3 bg-white text-black font-bold rounded-full hover:bg-gray-200 transition-colors flex items-center gap-2">
                                                    <Camera size={20}/> 保存海报
                                                </button>
                                                <button onClick={() => setResultImage(null)} className="p-3 border border-white/20 rounded-full hover:bg-white/10 text-white transition-colors">
                                                    <Trash2 size={20}/>
                                                </button>
                                            </div>
                                        </>
                                    ) : mode === 'text2img' && (
                                        <div className="flex flex-col items-center justify-center h-64 text-gray-500">
                                            {error ? (
                                                <div className="text-red-400 flex flex-col items-center">
                                                    <AlertCircle size={40} className="mb-2"/>
                                                    <p>{error}</p>
                                                </div>
                                            ) : (
                                                <>
                                                    <Sparkles size={48} className="mb-4 opacity-20"/>
                                                    <p>配置左侧参数，点击生成</p>
                                                </>
                                            )}
                                        </div>
                                    )}
                                 </div>
                             )}
                        </div>
                    </main>
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
