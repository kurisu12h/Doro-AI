<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>柏拉图 AI Studio - 本地版</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel 用于解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 配置 Import Map，让我们能像写普通 React 项目一样引用库 -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>

    <style>
        /* 自定义动画 */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.6s ease-out forwards;
        }
        .animate-fade-in {
            animation: fade-in-up 0.4s ease-out forwards;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
    </style>
</head>
<body class="bg-slate-900">
    <div id="root"></div>

    <!-- React 代码逻辑 -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Image, Settings, Sparkles, Download, AlertCircle, Loader2, Key, Palette, Maximize2, Trash2, Copy, ExternalLink, Terminal } from 'lucide-react';

        const App = () => {
            const [apiKey, setApiKey] = useState('');
            const [baseUrl, setBaseUrl] = useState('https://api.bltcy.ai/v1'); // 柏拉图 API 默认地址
            const [prompt, setPrompt] = useState('');
            const [loading, setLoading] = useState(false);
            const [resultImage, setResultImage] = useState(null);
            const [error, setError] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            
            // 模型配置
            const [model, setModel] = useState('nano-banana');
            const [size, setSize] = useState('1024x1024');

            useEffect(() => {
                const storedKey = localStorage.getItem('plato_api_key');
                const storedBaseUrl = localStorage.getItem('plato_base_url');
                if (storedKey) setApiKey(storedKey);
                if (storedBaseUrl) setBaseUrl(storedBaseUrl);
            }, []);

            const handleSaveSettings = () => {
                localStorage.setItem('plato_api_key', apiKey);
                localStorage.setItem('plato_base_url', baseUrl);
                setShowSettings(false);
            };

            const generateImage = async () => {
                if (!apiKey) {
                    setError('请先在设置中配置 API Key');
                    setShowSettings(true);
                    return;
                }
                if (!prompt) {
                    setError('请输入画面描述 (Prompt)');
                    return;
                }

                setLoading(true);
                setError('');
                setResultImage(null);

                try {
                    // 智能处理 Base URL，防止重复 v1
                    const cleanBaseUrl = baseUrl.replace(/\/$/, '');
                    const isV1Included = cleanBaseUrl.endsWith('/v1');
                    const endpoint = isV1Included 
                        ? `${cleanBaseUrl}/images/generations` 
                        : `${cleanBaseUrl}/v1/images/generations`;

                    console.log(`正在请求 API: ${endpoint}`);
                    console.log(`使用模型: ${model}`);

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            prompt: prompt,
                            n: 1,
                            size: size,
                        })
                    });

                    const data = await response.json();

                    // 在控制台打印完整日志，方便排查
                    console.log('柏拉图 API 响应:', data);

                    if (!response.ok) {
                        // 直接展示服务端返回的原始错误信息
                        const serverMsg = data.error?.message || JSON.stringify(data);
                        throw new Error(`服务端报错: ${serverMsg}`);
                    }

                    if (data.data && data.data.length > 0) {
                        setResultImage(data.data[0].url);
                    } else {
                        throw new Error('API 返回成功但没有图片数据 (data 字段为空)');
                    }

                } catch (err) {
                    console.error('生图请求失败:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleDownload = () => {
                if (resultImage) {
                    window.open(resultImage, '_blank');
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-slate-900 text-white font-sans selection:bg-pink-500 selection:text-white">
                
                {/* Navbar */}
                <nav className="border-b border-white/10 bg-black/20 backdrop-blur-md sticky top-0 z-50">
                    <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                    <div className="flex items-center gap-2">
                        <div className="bg-gradient-to-tr from-yellow-400 to-orange-500 p-2 rounded-lg">
                        <Palette size={20} className="text-white" />
                        </div>
                        <span className="font-bold text-xl tracking-tight">柏拉图 AI <span className="text-yellow-400 font-light">Studio</span></span>
                    </div>
                    <button 
                        onClick={() => setShowSettings(!showSettings)}
                        className="p-2 hover:bg-white/10 rounded-full transition-colors relative"
                    >
                        <Settings size={20} />
                        {!apiKey && <span className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>}
                    </button>
                    </div>
                </nav>

                <main className="max-w-6xl mx-auto px-4 py-8 flex flex-col md:flex-row gap-8">
                    
                    {/* Left Panel: Inputs */}
                    <div className="w-full md:w-1/3 flex flex-col gap-6 animate-fade-in-up">
                    
                    {/* Settings Card */}
                    {(showSettings || !apiKey) && (
                        <div className="bg-white/5 border border-white/10 rounded-2xl p-6 backdrop-blur-sm shadow-xl">
                        <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                            <Settings size={18} /> API 配置
                        </h2>
                        
                        <div className="space-y-4">
                            <div>
                            <label className="block text-xs text-gray-400 mb-1 uppercase tracking-wider">API Base URL</label>
                            <input 
                                type="text" 
                                value={baseUrl}
                                onChange={(e) => setBaseUrl(e.target.value)}
                                placeholder="https://api.bltcy.ai/v1"
                                className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-yellow-400 transition-colors placeholder-gray-600"
                            />
                            <p className="text-xs text-gray-500 mt-1">柏拉图默认地址 (无需修改)</p>
                            </div>

                            <div>
                            <label className="block text-xs text-gray-400 mb-1 uppercase tracking-wider">API Key (令牌)</label>
                            <div className="relative">
                                <Key size={16} className="absolute left-3 top-3 text-gray-500" />
                                <input 
                                type="password" 
                                value={apiKey}
                                onChange={(e) => setApiKey(e.target.value)}
                                placeholder="sk-..."
                                className="w-full bg-black/40 border border-white/10 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:border-yellow-400 transition-colors placeholder-gray-600"
                                />
                            </div>
                            </div>

                            <div className="flex gap-2">
                                <button 
                                    onClick={handleSaveSettings}
                                    className="flex-1 bg-white/10 hover:bg-white/20 text-white text-sm py-2 rounded-lg transition-colors"
                                >
                                    保存配置
                                </button>
                                <a 
                                    href="https://gpt-best.apifox.cn/doc-3530850" 
                                    target="_blank"
                                    rel="noreferrer"
                                    className="px-3 py-2 bg-blue-600/20 hover:bg-blue-600/30 text-blue-300 rounded-lg flex items-center justify-center transition-colors"
                                    title="查看文档"
                                >
                                    <ExternalLink size={16} />
                                </a>
                            </div>
                        </div>
                        </div>
                    )}

                    {/* Prompt Input Card */}
                    <div className="bg-white/5 border border-white/10 rounded-2xl p-6 backdrop-blur-sm shadow-xl flex-1 flex flex-col">
                        <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        <Sparkles size={18} className="text-yellow-400" /> 创意工坊
                        </h2>

                        <div className="space-y-4 flex-1">
                        <div>
                            <label className="block text-xs text-gray-400 mb-1 uppercase tracking-wider">模型 (Model)</label>
                            <div className="relative">
                                <input 
                                type="text" 
                                value={model}
                                onChange={(e) => setModel(e.target.value)}
                                className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-pink-500 transition-colors"
                                />
                                <div className="absolute right-2 top-2 text-[10px] text-gray-500 bg-white/5 px-2 rounded">推荐: nano-banana</div>
                            </div>
                        </div>

                        <div>
                            <label className="block text-xs text-gray-400 mb-1 uppercase tracking-wider">图片尺寸</label>
                            <select 
                            value={size}
                            onChange={(e) => setSize(e.target.value)}
                            className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-pink-500 transition-colors text-white"
                            >
                            <option value="1024x1024">1:1 (1024x1024)</option>
                            <option value="768x1024">3:4 (768x1024)</option>
                            <option value="1024x768">4:3 (1024x768)</option>
                            </select>
                        </div>

                        <div className="flex-1 flex flex-col">
                            <label className="block text-xs text-gray-400 mb-1 uppercase tracking-wider">提示词 (Prompt)</label>
                            <textarea 
                            value={prompt}
                            onChange={(e) => setPrompt(e.target.value)}
                            placeholder="一只穿着宇航服的可爱香蕉，在太空中漂浮，赛博朋克风格，霓虹灯光..."
                            className="w-full flex-1 min-h-[120px] bg-black/40 border border-white/10 rounded-lg p-4 text-sm focus:outline-none focus:border-pink-500 transition-colors resize-none placeholder-gray-600 leading-relaxed"
                            />
                        </div>

                        <button 
                            onClick={generateImage}
                            disabled={loading}
                            className={`w-full py-3 rounded-xl font-bold text-white shadow-lg flex items-center justify-center gap-2 transition-all transform hover:scale-[1.02] active:scale-[0.98] ${
                            loading 
                                ? 'bg-gray-600 cursor-not-allowed' 
                                : 'bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 shadow-pink-500/20'
                            }`}
                        >
                            {loading ? (
                            <><Loader2 size={20} className="animate-spin" /> 生成中...</>
                            ) : (
                            <><Sparkles size={20} /> 立即生成</>
                            )}
                        </button>
                        </div>
                    </div>
                    </div>

                    {/* Right Panel: Display */}
                    <div className="w-full md:w-2/3 h-[600px] md:h-auto bg-black/20 border border-white/10 rounded-2xl p-2 relative flex items-center justify-center overflow-hidden backdrop-blur-md group">
                        
                        {/* Background Grid Pattern */}
                        <div className="absolute inset-0 z-0 opacity-20" 
                            style={{
                                backgroundImage: 'radial-gradient(#ffffff 1px, transparent 1px)', 
                                backgroundSize: '20px 20px'
                            }}
                        ></div>

                        {!resultImage && !loading && !error && (
                            <div className="text-center z-10 p-8">
                                <div className="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4 border border-white/10">
                                    <Image size={32} className="text-gray-500" />
                                </div>
                                <h3 className="text-xl font-bold text-gray-300">准备创作</h3>
                                <p className="text-gray-500 mt-2 max-w-sm">在左侧输入你的奇思妙想，Nano Banana 模型将为你绘制出精美的图像。</p>
                            </div>
                        )}

                        {loading && (
                            <div className="z-10 flex flex-col items-center gap-4">
                                <div className="relative">
                                    <div className="w-16 h-16 border-4 border-pink-500/30 border-t-pink-500 rounded-full animate-spin"></div>
                                    <div className="absolute inset-0 flex items-center justify-center">
                                        <Sparkles size={16} className="text-yellow-400 animate-pulse" />
                                    </div>
                                </div>
                                <p className="text-gray-400 animate-pulse text-sm font-medium">AI 正在绘制中...</p>
                            </div>
                        )}

                        {error && (
                            <div className="z-10 bg-red-500/10 border border-red-500/30 p-6 rounded-xl text-center max-w-md mx-4 animate-fade-in-up">
                                <AlertCircle size={32} className="text-red-500 mx-auto mb-3" />
                                <h3 className="text-red-400 font-bold mb-2">生成出错</h3>
                                <div className="text-red-300/80 text-sm font-mono bg-black/30 p-3 rounded text-left overflow-auto max-h-32">
                                    {error}
                                </div>
                                <p className="text-xs text-red-400/50 mt-2">提示：如果错误信息包含 Gemini，说明柏拉图服务器当前将请求转发给了 Google 服务并报错，请尝试更换 Prompt 或稍后再试。</p>
                            </div>
                        )}

                        {resultImage && !loading && (
                            <div className="relative w-full h-full flex items-center justify-center z-10 animate-fade-in">
                                <img 
                                    src={resultImage} 
                                    alt="Generated Art" 
                                    className="max-w-full max-h-full object-contain rounded-lg shadow-2xl"
                                />
                                
                                {/* Hover Controls */}
                                <div className="absolute bottom-6 flex gap-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                    <button 
                                        onClick={handleDownload}
                                        className="bg-black/60 hover:bg-black/80 backdrop-blur-md text-white px-6 py-3 rounded-full flex items-center gap-2 border border-white/20 transition-all hover:scale-105"
                                    >
                                        <Download size={18} /> 下载原图
                                    </button>
                                    <button 
                                        onClick={() => setResultImage(null)}
                                        className="bg-red-500/20 hover:bg-red-500/40 backdrop-blur-md text-white p-3 rounded-full border border-red-500/30 transition-all hover:scale-105"
                                        title="清除"
                                    >
                                        <Trash2 size={18} />
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                </main>

                <footer className="text-center py-6 text-gray-500 text-xs">
                    <p>© 2025 Plato AI Studio • Powered by Nano Banana Model</p>
                </footer>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>