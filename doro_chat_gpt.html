<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChatGPT 5.1 - Doro UI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Markdown è§£æ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- ä»£ç é«˜äº®æ ·å¼ (æµ…è‰²) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background-color: #ffffff; 
            color: #374151;
            overflow: hidden; 
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #d1d5db; }

        .prose { color: #374151; max-width: none; font-size: 1rem; line-height: 1.75; }
        .prose pre { background: #f9fafb; border-radius: 8px; padding: 12px; overflow-x: auto; border: 1px solid #e5e7eb; margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose code { font-family: 'Menlo', 'Monaco', monospace; background: #f3f4f6; padding: 0.2em 0.4em; rounded: 4px; color: #ef4444; font-size: 0.875em; }
        .prose pre code { background: transparent; padding: 0; color: inherit; }
        .prose p { margin-bottom: 1em; }
        
        .msg-animate { animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .input-shadow:focus-within {
            box-shadow: 0 0 0 2px rgba(0,0,0,0.05), 0 4px 12px rgba(0,0,0,0.08);
            border-color: #d1d5db;
        }

        /* å¼¹çª—åŠ¨ç”» */
        @keyframes scale-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-scale-in { animation: scale-in 0.2s ease-out forwards; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="h-screen flex text-gray-800">
    <div id="root" class="h-full w-full flex"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useLayoutEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Settings, Send, Paperclip, Image as ImageIcon, User, Bot, Plus, Menu, X, ChevronDown, Loader2, LogOut, RefreshCw, PanelLeftClose, PanelLeftOpen, Sparkles, Search, Library, Box, Folder, FolderOpen, Mic, Activity, Grip, MessageSquarePlus, UserCircle2, CheckCircle2, LayoutGrid, ArrowRight, Globe, Copy, Trash2, MoreHorizontal, MessageSquare, Key, PenTool, GraduationCap, Zap, Layers, ScanFace } from 'lucide-react';

        const App = () => {
            // --- çŠ¶æ€ ---
            const [apiKey, setApiKey] = useState('');
            const [baseUrl, setBaseUrl] = useState('https://api.bltcy.ai/v1');
            
            // UI çŠ¶æ€
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [showSettings, setShowSettings] = useState(false);
            const [showTutorial, setShowTutorial] = useState(false); // æ•™ç¨‹å¼¹çª—
            const [showModelMenu, setShowModelMenu] = useState(false);
            const [hasChatStarted, setHasChatStarted] = useState(false);

            // èŠå¤©æ•°æ®
            const [chats, setChats] = useState([]); 
            const [activeChatId, setActiveChatId] = useState(null);
            const [systemPrompt, setSystemPrompt] = useState('You are a helpful assistant.');

            const [input, setInput] = useState('');
            const [isStreaming, setIsStreaming] = useState(false); 
            const [currentStreamContent, setCurrentStreamContent] = useState(''); 
            const [selectedFile, setSelectedFile] = useState(null); 
            
            // æ¨¡å‹
            const [models, setModels] = useState([]);
            const [currentModel, setCurrentModel] = useState('gpt-4o');
            const [loadingModels, setLoadingModels] = useState(false);

            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);
            const textareaRef = useRef(null);
            const abortControllerRef = useRef(null);

            // --- åˆå§‹åŒ– ---
            useEffect(() => {
                const storedKey = localStorage.getItem('plato_api_key');
                const storedBaseUrl = localStorage.getItem('plato_base_url');
                if (storedKey) setApiKey(storedKey);
                if (storedBaseUrl) setBaseUrl(storedBaseUrl);
                
                const storedSysPrompt = localStorage.getItem('doro_system_prompt');
                if (storedSysPrompt) setSystemPrompt(storedSysPrompt);

                const storedChats = localStorage.getItem('doro_chats');
                if (storedChats) {
                    const parsedChats = JSON.parse(storedChats);
                    setChats(parsedChats);
                    if (parsedChats.length > 0) setActiveChatId(parsedChats[0].id);
                    else createNewChat(parsedChats);
                } else {
                    createNewChat([]);
                }

                if (window.innerWidth < 1024) setSidebarOpen(false);

                // æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨æ˜¾ç¤ºæ•™ç¨‹
                const hasSeenTutorial = localStorage.getItem('doro_chat_tutorial_seen');
                if (!hasSeenTutorial) {
                    setShowTutorial(true);
                }
            }, []);

            // è‡ªåŠ¨ä¿å­˜
            useEffect(() => {
                if (chats.length > 0) localStorage.setItem('doro_chats', JSON.stringify(chats));
            }, [chats]);

            // æ»šåŠ¨
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [chats, activeChatId, isStreaming, currentStreamContent]);

            // é«˜åº¦è‡ªé€‚åº”
            useEffect(() => {
                if (textareaRef.current) {
                    textareaRef.current.style.height = '24px';
                    textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 200)}px`;
                }
            }, [input]);

            // --- æ ¸å¿ƒé€»è¾‘ ---
            const createNewChat = (currentChats = chats) => {
                const newChat = { id: Date.now().toString(), title: 'æ–°å¯¹è¯', messages: [], createdAt: Date.now() };
                const updatedChats = [newChat, ...currentChats];
                setChats(updatedChats);
                setActiveChatId(newChat.id);
                if (window.innerWidth < 1024) setSidebarOpen(false);
                setHasChatStarted(false); // Reset chat started state for new empty chat
                return newChat;
            };

            const deleteChat = (e, id) => {
                e.stopPropagation();
                const updatedChats = chats.filter(c => c.id !== id);
                setChats(updatedChats);
                if (updatedChats.length === 0) {
                    createNewChat([]);
                } else if (activeChatId === id) {
                    setActiveChatId(updatedChats[0].id);
                    setHasChatStarted(true); // Assume switching to existing chat starts it
                }
            };

            const clearAllChats = () => {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ')) {
                    setChats([]); createNewChat([]); localStorage.removeItem('doro_chats');
                }
            };

            const activeChat = chats.find(c => c.id === activeChatId) || chats[0] || { messages: [] };
            const messages = activeChat.messages || [];

            const fetchModels = async () => {
                if (!apiKey) return alert('è¯·å…ˆé…ç½® API Key');
                setLoadingModels(true);
                try {
                    const cleanBaseUrl = baseUrl.replace(/\/$/, '');
                    const endpoint = cleanBaseUrl.endsWith('/v1') ? `${cleanBaseUrl}/models` : `${cleanBaseUrl}/v1/models`;
                    const res = await fetch(endpoint, { headers: { 'Authorization': `Bearer ${apiKey}` } });
                    const data = await res.json();
                    if (data.data) {
                        const gptModels = data.data.filter(m => m.id.toLowerCase().includes('gpt'));
                        setModels(gptModels.sort((a, b) => a.id.localeCompare(b.id)));
                        if (gptModels.length > 0 && !gptModels.find(m => m.id === currentModel)) setCurrentModel(gptModels[0].id);
                    }
                } catch (err) { console.error(err); } finally { setLoadingModels(false); }
            };

            const updateChatMessages = (id, newMessages, title = null) => {
                setChats(prevChats => prevChats.map(c => {
                    if (c.id === id) return { ...c, messages: newMessages, title: title || c.title };
                    return c;
                }));
            };

            // --- å‘é€æ¶ˆæ¯ä¸æµå¼å¤„ç† ---
            const sendMessage = async (mode = 'chat') => {
                if ((!input.trim() && !selectedFile) || isStreaming) return;

                setHasChatStarted(true);
                const currentId = activeChatId;
                const userMsgContent = input;
                const userFile = selectedFile;
                
                setInput(''); setSelectedFile(null); setCurrentStreamContent('');
                if (textareaRef.current) textareaRef.current.style.height = 'auto';

                const newMsg = { role: 'user', content: userMsgContent, image: userFile };
                const updatedMessages = [...messages, newMsg];
                
                let newTitle = null;
                if (messages.length === 0) newTitle = userMsgContent.substring(0, 20) || 'æ–°å¯¹è¯';

                updateChatMessages(currentId, updatedMessages, newTitle);
                setIsStreaming(true);

                abortControllerRef.current = new AbortController();
                const signal = abortControllerRef.current.signal;

                try {
                    const cleanBaseUrl = baseUrl.replace(/\/$/, '');

                    // 1. ç”Ÿå›¾æ¨¡å¼ (Draw)
                    if (mode === 'draw') {
                        const endpoint = `${cleanBaseUrl}/images/generations`;
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({ model: 'nano-banana', prompt: userMsgContent, n: 1, size: "1024x1024" }),
                            signal
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error?.message || 'ç»˜å›¾å¤±è´¥');
                        
                        const assistantMsg = { role: 'assistant', content: `![Generated Image](${data.data[0].url})` };
                        updateChatMessages(currentId, [...updatedMessages, assistantMsg]);
                    } 
                    // 2. æ”¹å›¾æ¨¡å¼ (Edit)
                    else if (mode === 'edit') {
                        if (!userFile) throw new Error("æ”¹å›¾æ¨¡å¼å¿…é¡»å…ˆä¸Šä¼ å›¾ç‰‡ï¼");
                        const endpoint = `${cleanBaseUrl}/images/generations`;
                        const base64Image = userFile.split(',')[1];

                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({ 
                                model: 'nano-banana', 
                                prompt: userMsgContent,
                                image: base64Image,
                                n: 1, 
                                size: "1024x1024",
                                strength: 0.7 
                            }),
                            signal
                        });
                        
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error?.message || 'æ”¹å›¾å¤±è´¥');
                        
                        const assistantMsg = { role: 'assistant', content: `ğŸ¨ æ”¹å›¾å®Œæˆï¼š\n\n![Edited Image](${data.data[0].url})` };
                        updateChatMessages(currentId, [...updatedMessages, assistantMsg]);
                    }
                    // 3. æµå¼èŠå¤© (Chat Stream)
                    else {
                        const endpoint = cleanBaseUrl.endsWith('/v1') ? `${cleanBaseUrl}/chat/completions` : `${cleanBaseUrl}/v1/chat/completions`;
                        const systemMsg = { role: 'system', content: systemPrompt };
                        const apiMessages = [systemMsg, ...updatedMessages.map(m => {
                            if (m.image) return { role: m.role, content: [{ type: "text", text: m.content || "Image" }, { type: "image_url", image_url: { url: m.image } }] };
                            return { role: m.role, content: m.content };
                        })];

                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({ model: currentModel, messages: apiMessages, stream: true }),
                            signal
                        });

                        if (!response.ok) {
                            const errData = await response.json();
                            throw new Error(errData.error?.message || 'è¯·æ±‚å¤±è´¥');
                        }

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let fullContent = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            const chunk = decoder.decode(value, { stream: true });
                            const lines = chunk.split('\n').filter(line => line.trim() !== '');
                            
                            for (const line of lines) {
                                if (line === 'data: [DONE]') break;
                                if (line.startsWith('data: ')) {
                                    try {
                                        const json = JSON.parse(line.substring(6));
                                        const content = json.choices[0]?.delta?.content || '';
                                        if (content) {
                                            fullContent += content;
                                            setCurrentStreamContent(fullContent);
                                        }
                                    } catch (e) { console.error('Parse error', e); }
                                }
                            }
                        }
                        
                        const assistantMsg = { role: 'assistant', content: fullContent };
                        updateChatMessages(currentId, [...updatedMessages, assistantMsg]);
                        setCurrentStreamContent('');
                    }

                } catch (err) {
                    if (err.name !== 'AbortError') {
                        const errorMsg = { role: 'assistant', content: `Error: ${err.message}` };
                        updateChatMessages(currentId, [...updatedMessages, errorMsg]);
                    }
                } finally {
                    setIsStreaming(false);
                }
            };

            const stopGeneration = () => {
                if (abortControllerRef.current) {
                    abortControllerRef.current.abort();
                    setIsStreaming(false);
                    if (currentStreamContent) {
                        const assistantMsg = { role: 'assistant', content: currentStreamContent };
                        updateChatMessages(activeChatId, [...messages, assistantMsg]);
                        setCurrentStreamContent('');
                    }
                }
            };

            const closeTutorial = (dontShow) => {
                setShowTutorial(false);
                if (dontShow) localStorage.setItem('doro_chat_tutorial_seen', 'true');
            };

            const copyToClipboard = (text) => navigator.clipboard.writeText(text);

            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setSelectedFile(reader.result);
                    reader.readAsDataURL(file);
                }
                // ä¿®å¤ï¼šé‡ç½® input valueï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶
                e.target.value = null;
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage('chat');
                }
            };

            return (
                <div className="flex w-full h-full relative bg-white">
                    
                    {/* ä¾§è¾¹æ  */}
                    <div className={`${sidebarOpen ? 'w-[260px]' : 'w-0'} bg-[#f9f9f9] flex-shrink-0 flex flex-col transition-all duration-300 border-r border-gray-100 relative z-20 overflow-hidden`}>
                        <div className="p-3 flex justify-between items-center">
                            <button onClick={() => createNewChat()} className="flex-1 flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-sm text-gray-700 shadow-sm mr-2"><Plus size={16}/> <span className="font-medium">æ–°å¯¹è¯</span></button>
                            <button className="p-2 hover:bg-gray-200 rounded-md text-gray-500" title="æ”¶èµ·" onClick={() => setSidebarOpen(false)}><PanelLeftClose size={20}/></button>
                        </div>
                        <div className="flex-1 overflow-y-auto px-3 pb-4 no-scrollbar space-y-1">
                            <div className="px-2 mt-4 mb-2 text-xs font-medium text-gray-400 uppercase tracking-wider">æœ€è¿‘</div>
                            {chats.map(chat => (
                                <div key={chat.id} onClick={() => { setActiveChatId(chat.id); setHasChatStarted(true); if(window.innerWidth<1024) setSidebarOpen(false); }} className={`group flex items-center gap-3 px-3 py-3 rounded-lg text-sm cursor-pointer transition-colors ${activeChatId === chat.id ? 'bg-gray-200 text-black' : 'text-gray-600 hover:bg-gray-200/50'}`}>
                                    <MessageSquare size={16} className="flex-shrink-0"/>
                                    <span className="truncate flex-1">{chat.title || 'æ–°å¯¹è¯'}</span>
                                    <button onClick={(e) => deleteChat(e, chat.id)} className={`p-1 rounded hover:bg-gray-300 text-gray-400 hover:text-red-500 ${activeChatId === chat.id ? 'block' : 'hidden group-hover:block'}`}><Trash2 size={14}/></button>
                                </div>
                            ))}
                        </div>
                        <div className="p-2 border-t border-gray-200/50">
                            <button onClick={() => setShowSettings(true)} className="flex items-center gap-3 w-full px-3 py-3 rounded-xl hover:bg-gray-200 transition-colors text-sm text-gray-600"><Settings size={18} /><span>å…¨å±€è®¾ç½®</span></button>
                        </div>
                    </div>

                    {/* ä¸»å†…å®¹åŒº */}
                    <div className="flex-1 flex flex-col h-full relative bg-white min-w-0">
                        {/* é¡¶éƒ¨æ  */}
                        <div className="h-14 flex items-center justify-between px-4 absolute top-0 left-0 right-0 z-10 bg-white/80 backdrop-blur-sm">
                            <div className="flex items-center min-w-0">
                                {!sidebarOpen && <button onClick={() => setSidebarOpen(true)} className="p-2 mr-2 hover:bg-gray-100 rounded-md text-gray-500"><PanelLeftOpen size={20}/></button>}
                                <button onClick={() => { setShowModelMenu(!showModelMenu); if(!showModelMenu) fetchModels(); }} className="flex items-center gap-1 text-lg font-semibold text-gray-700 hover:bg-gray-100 px-3 py-1.5 rounded-lg transition-colors group truncate">
                                    <span className="truncate">{currentModel === 'nano-banana' ? 'ChatGPT 5.1' : currentModel}</span>
                                    <ChevronDown size={16} className="text-gray-400 group-hover:text-gray-600 flex-shrink-0"/>
                                </button>
                                {showModelMenu && (
                                    <div className="absolute top-12 left-4 bg-white border border-gray-200 rounded-xl shadow-xl z-50 w-64 py-1 animate-fade-in">
                                        <div className="px-3 py-2 text-xs font-medium text-gray-400 border-b border-gray-100">{loadingModels ? 'åŠ è½½ä¸­...' : 'åˆ‡æ¢æ¨¡å‹'}</div>
                                        <div className="max-h-64 overflow-y-auto">
                                            {models.length > 0 ? models.map(m => (<button key={m.id} onClick={() => { setCurrentModel(m.id); setShowModelMenu(false); }} className="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50 text-gray-700 flex justify-between items-center">{m.id} {currentModel === m.id && <CheckCircle2 size={14} className="text-green-500"/>}</button>)) : <div className="px-4 py-2 text-sm text-gray-500">è¯·åœ¨è®¾ç½®ä¸­é…ç½® Key</div>}
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="flex gap-2 flex-shrink-0">
                                <button onClick={() => setShowTutorial(true)} className="text-xs font-medium text-gray-600 hover:text-black bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded-full transition-colors flex items-center gap-1">
                                    <GraduationCap size={14}/> ä½¿ç”¨æŒ‡å—
                                </button>
                                <div className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 cursor-pointer"><UserCircle2 size={20}/></div>
                            </div>
                        </div>

                        {/* èŠå¤©åŒºåŸŸ */}
                        <div className="flex-1 overflow-y-auto relative pb-40 scroll-smooth">
                            {!hasChatStarted && messages.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center px-4 pb-20 animate-fade-in">
                                    <div className="text-center mb-8">
                                        <div className="bg-white p-4 rounded-full inline-block mb-6 shadow-sm border border-gray-100"><Bot size={56} className="text-gray-800" /></div>
                                        <h1 className="text-2xl md:text-3xl font-semibold text-gray-800 mb-2">æœ‰ä»€ä¹ˆå¯ä»¥å¸®å¿™çš„?</h1>
                                        {systemPrompt && systemPrompt !== 'You are a helpful assistant.' && <div className="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded border border-gray-100 inline-block max-w-xs truncate">å½“å‰è§’è‰²: {systemPrompt}</div>}
                                    </div>
                                </div>
                            ) : (
                                <div className="w-full max-w-3xl mx-auto pt-20 px-4">
                                    {messages.map((msg, idx) => (
                                        <div key={idx} className={`flex gap-4 mb-8 group ${msg.role === 'user' ? 'flex-row-reverse' : ''}`}>
                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 shadow-sm ${msg.role === 'user' ? 'bg-gray-100' : 'bg-white border border-gray-200'}`}>
                                                {msg.role === 'user' ? <User size={16} className="text-gray-600"/> : <Bot size={18} className="text-green-600"/>}
                                            </div>
                                            <div className={`relative max-w-[90%] md:max-w-[85%] text-[15px] leading-7 ${msg.role === 'user' ? 'bg-[#f4f4f4] px-4 py-2.5 rounded-2xl rounded-tr-sm text-gray-800' : 'text-gray-800 pt-1 group'}`}>
                                                {msg.image && <img src={msg.image} className="max-w-sm rounded-lg mb-3 border border-gray-200" />}
                                                <div className="prose" dangerouslySetInnerHTML={{ __html: marked.parse(msg.content || '') }} />
                                                {msg.role === 'assistant' && (
                                                    <div className="absolute -bottom-6 left-0 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button onClick={() => copyToClipboard(msg.content)} className="text-gray-400 hover:text-gray-600"><Copy size={14}/></button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    {isStreaming && currentStreamContent && (
                                        <div className="flex gap-4 mb-8 group">
                                            <div className="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center flex-shrink-0 shadow-sm"><Bot size={18} className="text-green-600"/></div>
                                            <div className="relative max-w-[90%] md:max-w-[85%] text-[15px] leading-7 text-gray-800 pt-1">
                                                <div className="prose cursor-blink" dangerouslySetInnerHTML={{ __html: marked.parse(currentStreamContent) }} />
                                            </div>
                                        </div>
                                    )}
                                    {isStreaming && !currentStreamContent && (
                                        <div className="flex gap-4 mb-6"><div className="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center"><Bot size={18} className="text-green-600"/></div><div className="flex items-center gap-1 h-6 pt-2"><div className="w-2 h-2 bg-gray-300 rounded-full animate-bounce"></div><div className="w-2 h-2 bg-gray-300 rounded-full animate-bounce delay-75"></div><div className="w-2 h-2 bg-gray-300 rounded-full animate-bounce delay-150"></div></div></div>
                                    )}
                                    <div ref={messagesEndRef} />
                                </div>
                            )}
                        </div>

                        {/* åº•éƒ¨è¾“å…¥æ  (å§‹ç»ˆå›ºå®šåœ¨åº•éƒ¨) */}
                        <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-white via-white to-transparent pt-4 pb-6 px-4 z-20">
                            <div className="max-w-3xl mx-auto relative w-full">
                                {isStreaming && (
                                    <div className="absolute -top-12 left-1/2 transform -translate-x-1/2">
                                        <button onClick={stopGeneration} className="bg-white border border-gray-200 text-gray-600 px-3 py-1.5 rounded-lg shadow-sm flex items-center gap-2 text-sm hover:bg-gray-50">
                                            <div className="w-2 h-2 bg-gray-600 rounded-sm"></div> åœæ­¢ç”Ÿæˆ
                                        </button>
                                    </div>
                                )}
                                
                                {selectedFile && (
                                    <div className="absolute bottom-full left-0 mb-2 p-2 bg-white shadow-lg border border-gray-100 rounded-lg flex items-center gap-2 animate-fade-in">
                                        <img src={selectedFile} className="w-12 h-12 rounded-md object-cover" />
                                        <button onClick={() => setSelectedFile(null)} className="absolute -top-1 -right-1 bg-white rounded-full shadow border border-gray-200 hover:bg-gray-100"><X size={14} className="text-gray-500"/></button>
                                    </div>
                                )}
                                <div className="bg-[#f4f4f4] rounded-[26px] border border-transparent focus-within:bg-white focus-within:border-gray-200 focus-within:shadow-lg transition-all input-shadow flex items-end p-2 gap-2 w-full">
                                    {/* æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„å‡½æ•°å handleFileSelect */}
                                    <button onClick={() => fileInputRef.current?.click()} className="p-2.5 text-gray-400 hover:text-gray-800 bg-transparent hover:bg-gray-200 rounded-full transition-colors flex-shrink-0"><Plus size={20} /></button>
                                    <textarea ref={textareaRef} value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={handleKeyDown} placeholder="å‘é€æ¶ˆæ¯..." className="flex-1 bg-transparent border-none outline-none text-gray-700 text-base py-3 resize-none min-h-[44px] max-h-[200px] placeholder-gray-400" rows={1}/>
                                    
                                    <div className="flex items-center gap-1 pb-1">
                                        {selectedFile && input.trim() && (
                                            <button onClick={() => sendMessage('edit')} className="p-2 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 transition-colors" title="GPTæ”¹å›¾"><PenTool size={18} /></button>
                                        )}
                                        {!selectedFile && input.trim() && (
                                            <button onClick={() => sendMessage('draw')} className="p-2 rounded-full hover:bg-gray-200 text-gray-500 hover:text-purple-500 transition-colors" title="ç”Ÿæˆå›¾ç‰‡"><ImageIcon size={18} /></button>
                                        )}
                                        <button onClick={() => sendMessage('chat')} className={`p-2 rounded-full transition-all duration-200 flex-shrink-0 ${input.trim() || selectedFile ? 'bg-black text-white' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`} disabled={!input.trim() && !selectedFile}>
                                            <ArrowRight size={18} />
                                        </button>
                                    </div>
                                </div>
                                <p className="text-xs text-gray-400 text-center mt-2">Doro AI can make mistakes. Check important info.</p>
                            </div>
                        </div>

                        {/* Tutorial Modal */}
                        {showTutorial && (
                            <div className="fixed inset-0 z-[110] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
                                <div className="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden relative max-h-[85vh] overflow-y-auto">
                                    <button onClick={() => closeTutorial(false)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100"><X size={24}/></button>
                                    
                                    <div className="p-8">
                                        <div className="mb-6 text-center">
                                            <div className="inline-block p-3 bg-green-100 rounded-2xl mb-4"><Bot size={40} className="text-green-600"/></div>
                                            <h2 className="text-2xl font-bold text-gray-800">æ¬¢è¿ä½¿ç”¨ Doro Chat</h2>
                                            <p className="text-gray-500 mt-2">æ‚¨çš„å…¨èƒ½ AI åŠ©æ‰‹ï¼šèŠå¤©ã€è¯†å›¾ã€ç”Ÿå›¾ã€æ”¹å›¾ã€‚</p>
                                        </div>

                                        <div className="grid gap-6 md:grid-cols-2">
                                            {/* 1. åŸºç¡€èŠå¤© */}
                                            <div className="space-y-3">
                                                <div className="flex items-center gap-2 text-gray-800 font-bold"><MessageSquare size={18} className="text-blue-500"/> åŸºç¡€å¯¹è¯</div>
                                                <p className="text-sm text-gray-500 leading-relaxed">å°±åƒä½¿ç”¨å®˜æ–¹ ChatGPT ä¸€æ ·ã€‚è¾“å…¥é—®é¢˜ï¼ŒæŒ‰å›è½¦å‘é€ã€‚æ”¯æŒ Markdown ä»£ç é«˜äº®å’Œæµå¼è¾“å‡ºã€‚</p>
                                            </div>

                                            {/* 2. è§†è§‰è¯†åˆ« */}
                                            <div className="space-y-3">
                                                <div className="flex items-center gap-2 text-gray-800 font-bold"><ScanFace size={18} className="text-orange-500"/> è§†è§‰è¯†åˆ« (Vision)</div>
                                                <p className="text-sm text-gray-500 leading-relaxed">ç‚¹å‡»å·¦ä¾§ <strong className="text-gray-700">+</strong> å·ä¸Šä¼ å›¾ç‰‡ï¼Œè¯¢é—® "è¿™å¼ å›¾é‡Œæœ‰ä»€ä¹ˆï¼Ÿ" æˆ– "å¸®æˆ‘å†™è¿™æ®µä»£ç "ã€‚</p>
                                            </div>

                                            {/* 3. AI ç»˜ç”» */}
                                            <div className="space-y-3">
                                                <div className="flex items-center gap-2 text-gray-800 font-bold"><ImageIcon size={18} className="text-purple-500"/> AI ç»˜ç”» (DALL-E)</div>
                                                <p className="text-sm text-gray-500 leading-relaxed">è¾“å…¥ç”»é¢æè¿°ï¼ˆå¦‚â€œä¸€åªèµ›åšæœ‹å…‹çŒ«â€ï¼‰ï¼Œç„¶åç‚¹å‡»è¾“å…¥æ¡†å³ä¾§å‡ºç°çš„ <strong className="text-gray-700">å›¾ç‰‡å›¾æ ‡</strong> å³å¯ç”Ÿå›¾ã€‚</p>
                                            </div>

                                            {/* 4. AI æ”¹å›¾ */}
                                            <div className="space-y-3">
                                                <div className="flex items-center gap-2 text-gray-800 font-bold"><PenTool size={18} className="text-pink-500"/> AI æ”¹å›¾ (Edit)</div>
                                                <p className="text-sm text-gray-500 leading-relaxed">ä¸Šä¼ ä¸€å¼ å›¾ç‰‡ï¼Œå¹¶è¾“å…¥ä¿®æ”¹æŒ‡ä»¤ï¼ˆå¦‚â€œæŠŠèƒŒæ™¯å˜æˆé›ªå¤©â€ï¼‰ï¼Œç‚¹å‡»å³ä¾§å‡ºç°çš„ <strong className="text-gray-700">ç”»ç¬”å›¾æ ‡</strong>ã€‚</p>
                                            </div>
                                        </div>

                                        <div className="mt-8 p-4 bg-gray-50 rounded-xl border border-gray-100 text-sm text-gray-600">
                                            <strong className="block text-gray-800 mb-1 flex items-center gap-2"><Zap size={14}/> å°æŠ€å·§</strong>
                                            åœ¨â€œè®¾ç½®â€ä¸­å¯ä»¥è‡ªå®šä¹‰ <b>ç³»ç»Ÿæç¤ºè¯ (System Prompt)</b>ï¼Œè®© AI æ‰®æ¼”ç‰¹å®šçš„è§’è‰²ï¼ˆå¦‚â€œç¿»è¯‘å®˜â€ã€â€œPython ä¸“å®¶â€ï¼‰ã€‚
                                        </div>
                                    </div>

                                    <div className="p-4 border-t border-gray-100 bg-gray-50 flex justify-between items-center">
                                        <button onClick={() => closeTutorial(true)} className="text-xs text-gray-400 hover:text-gray-600 flex items-center gap-2">
                                            <div className="w-4 h-4 border border-gray-300 rounded bg-white"></div> ä¸å†è‡ªåŠ¨æ˜¾ç¤º
                                        </button>
                                        <button onClick={() => closeTutorial(false)} className="px-6 py-2.5 bg-black text-white font-bold text-sm rounded-lg hover:bg-gray-800 transition-colors">å¼€å§‹ä½“éªŒ</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Settings Modal (ä¿æŒä¸å˜) */}
                        {showSettings && (
                            <div className="fixed inset-0 bg-black/20 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
                                <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform transition-all">
                                    <div className="flex justify-between items-center mb-6"><h3 className="text-lg font-semibold text-gray-800">Settings</h3><button onClick={() => setShowSettings(false)}><X size={20} className="text-gray-400 hover:text-gray-600"/></button></div>
                                    <div className="space-y-5">
                                        <div><label className="block text-xs text-gray-500 mb-1.5 font-medium uppercase tracking-wider">API Key</label><div className="relative"><Key size={16} className="absolute left-3 top-3 text-gray-400"/><input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} className="w-full bg-gray-50 border border-gray-200 rounded-xl p-2.5 pl-10 text-sm outline-none focus:border-gray-400 focus:ring-2 focus:ring-gray-100 transition-all" placeholder="sk-..." /></div></div>
                                        <div><label className="block text-xs text-gray-500 mb-1.5 font-medium uppercase tracking-wider">Base URL</label><div className="relative"><Globe size={16} className="absolute left-3 top-3 text-gray-400"/><input type="text" value={baseUrl} onChange={e => setBaseUrl(e.target.value)} className="w-full bg-gray-50 border border-gray-200 rounded-xl p-2.5 pl-10 text-sm outline-none focus:border-gray-400 focus:ring-2 focus:ring-gray-100 transition-all" placeholder="https://api.bltcy.ai/v1" /></div></div>
                                        <div><label className="block text-xs text-gray-500 mb-1.5 font-medium uppercase tracking-wider">ç³»ç»Ÿæç¤ºè¯</label><textarea value={systemPrompt} onChange={e => setSystemPrompt(e.target.value)} className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm outline-none focus:border-gray-400 focus:ring-2 focus:ring-gray-100 transition-all h-20 resize-none" placeholder="ä¾‹å¦‚: You are a helpful assistant."/></div>
                                        <div className="pt-2 flex gap-3"><button onClick={clearAllChats} className="flex-1 py-2.5 text-sm bg-red-50 text-red-500 hover:bg-red-100 rounded-xl font-medium transition-colors border border-red-100">æ¸…ç©ºè®°å½•</button><button onClick={() => { localStorage.setItem('plato_api_key', apiKey); localStorage.setItem('plato_base_url', baseUrl); localStorage.setItem('doro_system_prompt', systemPrompt); setShowSettings(false); window.location.reload(); }} className="flex-[2] py-2.5 text-sm bg-black text-white rounded-xl hover:bg-gray-800 font-medium transition-colors shadow-lg shadow-gray-200">Save changes</button></div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* éšè—çš„æ–‡ä»¶è¾“å…¥ (å¿…é¡»æ”¾åœ¨ DOM ä¸­) */}
                    <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileSelect} />
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
